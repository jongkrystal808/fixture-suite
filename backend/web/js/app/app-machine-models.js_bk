/* ============================================================
 * app-machine-models.js  (v4.5 - èªæ³•ä¿®æ­£ç‰ˆ)
 * æ–°ç‰ˆä¸‰æ®µå¼ UIï¼š
 * 1) ç¶å®šç«™é»
 * 2) æ¯ç«™æ²»å…·éœ€æ±‚ CRUD
 * 3) æœ€å¤§å¯é–‹ç«™æ•¸
 *
 * å°æ‡‰å¾Œç«¯ routerï¼š/model-detail/*
 * ============================================================ */


/* ============================================================
 * ğŸ” Admin Only Guardï¼ˆå¾Œå°æ¨¡çµ„æ­£å¼å®£å‘Šï¼‰
 * ============================================================ */
(function () {
  if (!window.currentUser || window.currentUser.role !== "admin") {
    console.warn("[app-machine-models] not admin, module disabled");
    return;
  }
})();


function getCurrentCustomerId() {
  return localStorage.getItem("current_customer_id");
}

let currentSelectedModel = null;
let currentSelectedStation = null;


/* ============================================================
 * ğŸ§­ Admin Sidebar Entry
 * å¾Œå°ç®¡ç† â†’ æ©Ÿç¨®ç®¡ç†
 * ============================================================ */
function loadAdminMachineModels() {
  const customerId = getCurrentCustomerId();
  if (!customerId) {
    alert("è«‹å…ˆé¸æ“‡å®¢æˆ¶");
    return;
  }

  // é€™è£¡å‘¼å«ä½ ã€ŒåŸæœ¬å°±æœ‰ã€çš„æ©Ÿç¨®åˆ—è¡¨è¼‰å…¥é‚è¼¯
  // å¸¸è¦‹å‘½åï¼ˆæ“‡ä¸€å­˜åœ¨å³å¯ï¼‰ï¼š
  if (typeof loadMachineModelList === "function") {
    loadMachineModelList(customerId);
  } else if (typeof loadModels === "function") {
    loadModels(customerId);
  } else {
    console.warn("[app-machine-models] model list loader not found");
  }
}


window.loadAdminMachineModels = loadAdminMachineModels;

/* ============================================================
 * ğŸ“‹ æ©Ÿç¨®æ¸…å–®è¼‰å…¥ï¼ˆHTML å…¥å£ï¼‰
 * ============================================================ */
async function mmLoadModelList() {
  const customer_id = getCurrentCustomerId();
  if (!customer_id) {
    alert("è«‹å…ˆé¸æ“‡å®¢æˆ¶");
    return;
  }

  const search = document.getElementById("mmSearch")?.value.trim() || "";

  try {
    // âš ï¸ é€™è£¡å‡è¨­ä½ å¾Œç«¯å·²æœ‰ models list API
    // å¸¸è¦‹ï¼šGET /models?customer_id=&search=
    const params = { customer_id };
    if (search) params.search = search;

    const list = await apiListMachineModels(params);

    renderMachineModelTable(list);
  } catch (err) {
    console.error(err);
    toast("è¼‰å…¥æ©Ÿç¨®æ¸…å–®å¤±æ•—", "error");
  }
}

/* ============================================================
 * æ¸²æŸ“æ©Ÿç¨®æ¸…å–®è¡¨æ ¼
 * ============================================================ */
function renderMachineModelTable(list) {
  const tbody = document.getElementById("mmTable");
  const count = document.getElementById("mmCount");

  if (!tbody) return;

  tbody.innerHTML = "";
  count && (count.textContent = list?.length || 0);

  if (!Array.isArray(list) || list.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="3" class="py-3 text-center text-gray-400">
          ç„¡è³‡æ–™
        </td>
      </tr>`;
    return;
  }

  list.forEach(m => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${m.id}</td>
      <td>${m.model_name}</td>
      <td class="text-right flex gap-2 justify-end">
        <button class="btn btn-xs btn-outline"
                onclick="mmEditModel('${m.id}')">
          ä¿®æ”¹
        </button>
        <button class="btn btn-xs btn-error"
                onclick="mmDeleteModel('${m.id}')">
          åˆªé™¤
        </button>
      </td>
    `;

    tbody.appendChild(tr);
  });
}

function mmEditModel(modelId) {
  currentSelectedModel = modelId;

  // é¡¯ç¤ºå³å´ Stage â‘¡ + â‘¢
  document.getElementById("admin-msNoModelHint")?.classList.add("hidden");
  document.getElementById("admin-msContent")?.classList.remove("hidden");

  // æ¨™é¡Œé¡¯ç¤ºç›®å‰æ©Ÿç¨®
  const label = document.getElementById("msSelectedModelLabel");
  if (label) label.textContent = `ï¼ˆ${modelId}ï¼‰`;

    // æ¸…ç©º Stage â‘¢ ç‹€æ…‹
  currentSelectedStation = null;
  document.getElementById("frContent")?.classList.add("hidden");
  document.getElementById("frNoModelStationHint")?.classList.remove("hidden");

  // è¼‰å…¥ç«™é»ç¶å®šè³‡æ–™
  msReloadForCurrentModel();
}
window.mmEditModel = mmEditModel;

async function mmDeleteModel(modelId) {
  if (!confirm(`ç¢ºå®šè¦åˆªé™¤æ©Ÿç¨® ${modelId}ï¼Ÿ`)) return;

  try {
    await apiDeleteMachineModel(modelId);
    toast("æ©Ÿç¨®å·²åˆªé™¤");
    mmLoadModelList();
  } catch (err) {
    console.error(err);
    toast("åˆªé™¤å¤±æ•—ï¼Œå¯èƒ½å·²æœ‰ç«™é»æˆ–æ²»å…·é—œè¯", "error");
  }
}
window.mmDeleteModel = mmDeleteModel;


/* ============================================================
 * ğŸŸ¦ æ©Ÿç¨® Modalï¼šæ–°å¢ / ç·¨è¼¯ï¼ˆHTML å…¥å£ï¼‰
 * ============================================================ */
function mmOpenModelModal(mode, modelId = null) {
  const modal = document.getElementById("mmModelModal");
  const title = document.getElementById("mmModelModalTitle");
  const form = document.getElementById("mmModelForm");

  if (!modal || !form) {
    console.error("mmModelModal or mmModelForm not found");
    return;
  }

  form.reset();
  form.dataset.mode = mode;
  form.dataset.id = modelId || "";

  if (mode === "create") {
    title.textContent = "æ–°å¢æ©Ÿç¨®";
    document.getElementById("mmModelId").disabled = false;
  } else {
    title.textContent = "ç·¨è¼¯æ©Ÿç¨®";
    document.getElementById("mmModelId").disabled = true;
    // âš ï¸ å¦‚æœä½ ä¹‹å¾Œæœ‰è¦è¼‰å…¥æ—¢æœ‰è³‡æ–™ï¼Œå†è£œå³å¯
  }

  modal.classList.remove("hidden");
}
window.showTab = showTab;
window.mmOpenModelModal = mmOpenModelModal;


/* ============================================================
 * é‡æ–°è¼‰å…¥ç¶å®šç«™é» + å¯ç¶å®šç«™é»
 * ============================================================ */
async function msReloadForCurrentModel() {
  const customer_id = getCurrentCustomerId();
  if (!customer_id || !currentSelectedModel) return;

  // ğŸ”¥ ç”¨ã€Œå·²é©—è­‰æ­£ç¢ºã€çš„ model detail API
  const data = await apiGetModelDetail(currentSelectedModel);

  const bound = data.stations || [];

  // å¯ç¶å®šç«™é» = å…¨ç«™é» - å·²ç¶å®šç«™é»
  const allStations = await apiListStations({ customer_id });

  const boundIds = new Set(bound.map(s => s.station_id));
  const available = allStations.filter(s => !boundIds.has(s.id));

  renderBoundStationsTable(bound);
  renderAvailableStationsTable(
    available.map(s => ({
      station_id: s.id,
      station_name: s.station_name
    }))
  );

  document.getElementById("admin-msNoModelHint")?.classList.add("hidden");
  document.getElementById("admin-msContent")?.classList.remove("hidden");
}

/* --------------------- ç¶å®šç«™é»åˆ—è¡¨ ----------------------- */
function renderBoundStationsTable(rows) {
  const tbody = document.getElementById("admin-msBoundTable");
  if (!tbody) {
    console.error("admin-msBoundTable not found");
    return;
  }

  tbody.innerHTML = "";

  if (!rows || rows.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="3" class="text-gray-400 py-1 text-center">ç„¡è³‡æ–™</td>
      </tr>`;
    return;
  }

  rows.forEach((s) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="py-1 px-2">${s.station_id}</td>
      <td class="py-1 px-2">${s.station_name || "-"}</td>
      <td class="py-1 px-2 text-right flex gap-2 justify-end">
        <button class="btn btn-xs btn-outline"
                onclick="openStationRequirements('${s.station_id}', '${s.station_name || s.station_id}')">
          ä¿®æ”¹
        </button>
        <button class="btn btn-xs btn-error"
                onclick="msUnbindStation('${s.station_id}')">
          è§£ç¶
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* --------------------- å¯ç¶å®šç«™é» ----------------------- */
function renderAvailableStationsTable(rows) {
  const tbody = document.getElementById("admin-msAvailableTable");
  if (!tbody) {
    console.error("admin-msAvailableTable not found");
    return;
  }

  tbody.innerHTML = "";

  if (!rows || rows.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="3" class="text-gray-400 py-1 text-center">ç„¡å¯ç¶å®šç«™é»</td>
      </tr>`;
    return;
  }

  rows.forEach((s) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="py-1 px-2">${s.station_id}</td>
      <td class="py-1 px-2">${s.station_name || "-"}</td>
      <td class="py-1 px-2 text-right">
        <button class="btn btn-primary btn-xs"
                onclick="msBindStation('${s.station_id}', '${s.station_name || s.station_id}')">
          ç¶å®š
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}


/* --------------------- ç¶å®šç«™é» ----------------------- */
async function msBindStation(stationId, stationName = "") {
  await apiBindStationToModel(currentSelectedModel, stationId);

  currentSelectedStation = stationId;

  await msReloadForCurrentModel();

  // ğŸ”¥ ç¶å®šå¾Œç›´æ¥é€² Stage â‘¢
  openStationRequirements(stationId, stationName);
}




/* --------------------- è§£é™¤ç¶å®š ----------------------- */
async function msUnbindStation(stationId) {
  await apiUnbindStationFromModel(currentSelectedModel, stationId);
  msReloadForCurrentModel();
}

/* ============================================================
 * ğŸ”¥ æ‰“é–‹ã€Œæ²»å…·éœ€æ±‚ç·¨è¼¯ã€ (æŸç«™é»)
 * ============================================================ */
function openStationRequirements(stationId, stationName = "") {
  currentSelectedStation = stationId;

  // ===== æ›´æ–° Stage â‘¢ æ¨™é¡Œ =====
  const stationLabel = document.getElementById("frSelectedStationLabel");
  if (stationLabel) {
    stationLabel.textContent = stationName || stationId;
  }

  // ===== é¡¯ç¤º Stage â‘¢ï¼Œéš±è—æç¤º =====
  document.getElementById("frNoModelStationHint")?.classList.add("hidden");
  document.getElementById("frContent")?.classList.remove("hidden");

  // ===== è¼‰å…¥æ²»å…·éœ€æ±‚ =====
  loadStationRequirements(currentSelectedModel, stationId);
}


/* ------------------------------------------------------------
 * è®€å–è©²ç«™é»æ‰€æœ‰æ²»å…·éœ€æ±‚
 * ------------------------------------------------------------ */
async function loadStationRequirements(model_id, station_id) {
  const list = await apiListFixtureRequirements(model_id, station_id);
  renderStationRequirements(list);
}

/* ------------------------------------------------------------
 * æ¸²æŸ“åˆ—è¡¨
 * ------------------------------------------------------------ */
function renderStationRequirements(list) {
  const tbody = document.getElementById("stationDetailTable");
  tbody.innerHTML = "";

  if (!list.length) {
    tbody.innerHTML = `<tr><td colspan="5" class="py-3 text-gray-400 text-center">
        å°šæœªè¨­å®šæ²»å…·éœ€æ±‚
    </td></tr>`;
    return;
  }

  list.forEach((r) => {
    const max_station = r.required_qty > 0
      ? Math.floor((r.available_qty || 0) / r.required_qty)
      : "-";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.fixture_id}</td>
      <td>${r.fixture_name}</td>
      <td>${r.required_qty}</td>
      <td>${r.available_qty}</td>
      <td>${max_station}</td>
      <td class="py-1 flex gap-2 justify-center">
        <button class="btn btn-xs btn-outline"
            onclick="openEditRequirementModal(${r.id}, ${r.required_qty}, '${r.note || ""}')">
          ç·¨è¼¯
        </button>
        <button class="btn btn-xs btn-error text-white"
            onclick="deleteRequirement(${r.id})">
          åˆªé™¤
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ============================================================
 * ğŸŸ¦ Modalï¼šæ–°å¢æ²»å…·éœ€æ±‚
 * ============================================================ */
function openAddRequirementModal() {
  document.getElementById("reqModalTitle").textContent = "æ–°å¢æ²»å…·éœ€æ±‚";
  document.getElementById("reqModalRequiredQty").value = "";
  document.getElementById("reqModalFixtureId").value = "";
  document.getElementById("reqModalNote").value = "";
  document.getElementById("reqModalMode").value = "create";
  document.getElementById("requirementModal").style.display = "flex";
}

function closeRequirementModal() {
  document.getElementById("requirementModal").style.display = "none";
}

/* ============================================================
 * ğŸŸ§ Modalï¼šç·¨è¼¯æ²»å…·éœ€æ±‚
 * ============================================================ */
function openEditRequirementModal(id, qty, note) {
  document.getElementById("reqModalTitle").textContent = "ç·¨è¼¯æ²»å…·éœ€æ±‚";
  document.getElementById("reqModalMode").value = "edit";
  document.getElementById("reqModalReqId").value = id;
  document.getElementById("reqModalRequiredQty").value = qty;
  document.getElementById("reqModalNote").value = note || "";
  document.getElementById("requirementModal").style.display = "flex";
}

/* ============================================================
 * æ–°å¢ or ç·¨è¼¯æ²»å…·éœ€æ±‚çš„æäº¤æŒ‰éˆ•
 * ============================================================ */
async function submitRequirementModal() {
  const mode = document.getElementById("reqModalMode").value;
  const model_id = currentSelectedModel;
  const station_id = currentSelectedStation;

  const required_qty = parseInt(document.getElementById("reqModalRequiredQty").value);
  const note = document.getElementById("reqModalNote").value;

  if (mode === "create") {
    const fixture_id = document.getElementById("reqModalFixtureId").value;
    if (!fixture_id) return alert("è«‹è¼¸å…¥æ²»å…·ç·¨è™Ÿ");

    await apiCreateFixtureRequirement(model_id, station_id, {
      fixture_id,
      required_qty,
      note,
    });

  } else {
    const req_id = document.getElementById("reqModalReqId").value;

    await apiUpdateFixtureRequirement(req_id, {
      required_qty,
      note,
    });
  }

  closeRequirementModal();
  loadStationRequirements(model_id, station_id);
}

/* ============================================================
 * åˆªé™¤æ²»å…·éœ€æ±‚
 * ============================================================ */
async function deleteRequirement(req_id) {
  if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†æ²»å…·éœ€æ±‚å—ï¼Ÿ")) return;

  await apiDeleteFixtureRequirement(req_id);
  loadStationRequirements(currentSelectedModel, currentSelectedStation);
}


/* ============================================================
 * ğŸŸ¦ Model Detail Drawerï¼ˆv4.5 èªæ³•ä¿®æ­£ç‰ˆï¼‰
 * ============================================================ */
async function openModelDetail(modelId) {
  currentSelectedModel = modelId;

  const drawer = document.getElementById("modelDetailDrawer");
  const box = document.getElementById("modelDetailContent");

  drawer.classList.remove("translate-x-full");
  box.innerHTML = `<div class="p-4 text-gray-500">è¼‰å…¥ä¸­...</div>`;

  try {
    const data = await apiGetModelDetail(modelId);
    const m = data.model;
    const stations = data.stations;
    const requirements = data.requirements;
    const capacity = data.capacity;

    box.innerHTML = `
<section class="space-y-6">

  <!-- Tabs: åˆ†é é¸é … -->
  <div class="border-b border-gray-200">
    <ul class="flex space-x-4">
      <li>
        <button id="tab-basic" 
                class="tab-button px-4 py-2 text-sm font-medium text-gray-600 hover:text-blue-600 border-b-2 border-transparent transition-colors" 
                onclick="showTab('basic')">
          åŸºæœ¬è³‡æ–™
        </button>
      </li>
      <li>
        <button id="tab-stations" 
                class="tab-button px-4 py-2 text-sm font-medium text-gray-600 hover:text-blue-600 border-b-2 border-transparent transition-colors" 
                onclick="showTab('stations')">
          ç¶å®šç«™é»
        </button>
      </li>
      <li>
        <button id="tab-requirements" 
                class="tab-button px-4 py-2 text-sm font-medium text-gray-600 hover:text-blue-600 border-b-2 border-transparent transition-colors" 
                onclick="showTab('requirements')">
          æ²»å…·éœ€æ±‚
        </button>
      </li>
      <li>
        <button id="tab-capacity" 
                class="tab-button px-4 py-2 text-sm font-medium text-gray-600 hover:text-blue-600 border-b-2 border-transparent transition-colors" 
                onclick="showTab('capacity')">
          æœ€å¤§é–‹ç«™æ•¸
        </button>
      </li>
    </ul>
  </div>

  <!-- åŸºæœ¬è³‡æ–™ -->
  <div id="basic" class="tab-content p-4">
    <div class="border p-4 rounded-xl bg-white shadow-md">
      <h3 class="text-lg font-semibold mb-3">åŸºæœ¬è³‡æ–™</h3>
      <div class="grid grid-cols-2 gap-3 text-sm">
        <div><span class="font-medium text-gray-700">æ©Ÿç¨®ä»£ç¢¼ï¼š</span>${m.id}</div>
        <div><span class="font-medium text-gray-700">åç¨±ï¼š</span>${m.model_name}</div>
        <div><span class="font-medium text-gray-700">å®¢æˆ¶ï¼š</span>${m.customer_id}</div>
        <div class="col-span-2"><span class="font-medium text-gray-700">å‚™è¨»ï¼š</span>${m.note || "-"}</div>
      </div>
    </div>
  </div>

  <!-- ç¶å®šç«™é» -->
  <div id="stations" class="tab-content p-4 hidden">
    <div class="border p-4 rounded-xl bg-white shadow-md">
      <h3 class="text-lg font-semibold mb-3">ç¶å®šç«™é»</h3>
      ${stations.length
        ? `<ul class="list-disc pl-6 text-sm space-y-1">${stations.map(
            (s) => `<li>${s.station_id} - ${s.station_name}</li>`
          ).join("")}</ul>`
        : `<p class="text-gray-500 text-sm">ç„¡ç¶å®šç«™é»</p>`
      }
    </div>
  </div>

  <!-- æ²»å…·éœ€æ±‚ -->
  <div id="requirements" class="tab-content p-4 hidden">
    <div class="border p-4 rounded-xl bg-white shadow-md">
      <h3 class="text-lg font-semibold mb-3">æ¯ç«™æ²»å…·éœ€æ±‚</h3>
      <div class="space-y-3">
      ${requirements.length
        ? requirements
            .map(
              (r) => `
          <div class="border rounded-lg p-3 bg-gray-50 text-sm space-y-1">
            <div><span class="font-medium text-gray-700">ç«™é»ï¼š</span>${r.station_id}</div>
            <div><span class="font-medium text-gray-700">æ²»å…·ï¼š</span>${r.fixture_id} - ${r.fixture_name}</div>
            <div><span class="font-medium text-gray-700">éœ€æ±‚æ•¸é‡ï¼š</span>${r.required_qty}</div>
            <div><span class="font-medium text-gray-700">å¯ç”¨æ•¸é‡ï¼š</span>${r.available_qty}</div>
          </div>`
            )
            .join("")
        : `<p class="text-gray-500 text-sm">ç„¡æ²»å…·éœ€æ±‚</p>`
      }
      </div>
    </div>
  </div>

  <!-- æœ€å¤§é–‹ç«™æ•¸ -->
  <div id="capacity" class="tab-content p-4 hidden">
    <div class="border p-4 rounded-xl bg-white shadow-md">
      <h3 class="text-lg font-semibold mb-3">æœ€å¤§å¯é–‹ç«™æ•¸</h3>
      <div class="space-y-3">
      ${capacity.length
        ? capacity
            .map(
              (c) => `
          <div class="border rounded-lg p-3 bg-green-50 text-sm space-y-1">
            <div><span class="font-medium text-gray-700">ç«™é»ï¼š</span>${c.station_id}</div>
            <div><span class="font-medium text-green-700">æœ€å¤§å¯é–‹ï¼š</span>${c.max_station} ç«™</div>
            <div class="text-xs text-gray-600 mt-1">
              (ç“¶é ¸æ²»å…·ï¼š${c.bottleneck_fixture_id}ï¼Œå¯æä¾› ${c.bottleneck_qty})
            </div>
          </div>`
            )
            .join("")
        : `<p class="text-gray-500 text-sm">æœªè¨ˆç®—æˆ–ç„¡è³‡æ–™</p>`
      }
      </div>
    </div>
  </div>

</section>
    `;

    showTab('basic');

  } catch (error) {
    console.error('è¼‰å…¥æ©Ÿç¨®è©³æƒ…å¤±æ•—:', error);
    box.innerHTML = `<div class="p-4 text-red-500">è¼‰å…¥å¤±æ•—ï¼š${error.message}</div>`;
  }
}

/* ============================================================
 * Tab åˆ‡æ›å‡½æ•¸
 * ============================================================ */
function showTab(tabName) {
  const tabContent = document.getElementById(tabName);
  const tabButton = document.getElementById(`tab-${tabName}`);

  if (!tabContent || !tabButton) {
    console.error(`Tab or tab button with ID "${tabName}" not found.`);
    return;
  }

  // éš±è—æ‰€æœ‰ tab å…§å®¹
  const tabs = document.querySelectorAll('.tab-content');
  tabs.forEach(tab => tab.classList.add('hidden'));

  // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active æ¨£å¼
  const buttons = document.querySelectorAll('.tab-button');
  buttons.forEach(button => {
    button.classList.remove('text-blue-600', 'border-blue-600');
    button.classList.add('text-gray-600', 'border-transparent');
  });

  // é¡¯ç¤ºè¢«é¸ä¸­çš„ tab å…§å®¹ä¸¦é«˜äº®æŒ‰éˆ•
  tabContent.classList.remove('hidden');
  tabButton.classList.remove('text-gray-600', 'border-transparent');
  tabButton.classList.add('text-blue-600', 'border-blue-600');
}


/* ============================================================
 * é—œé–‰ Drawer
 * ============================================================ */
function closeModelDetail() {
  document.getElementById("modelDetailDrawer").classList.add("translate-x-full");
}

/* ============================================================
 * Export Functions
 * ============================================================ */
window.msReloadForCurrentModel = msReloadForCurrentModel;
window.msBindStation = msBindStation;
window.msUnbindStation = msUnbindStation;
window.openStationRequirements = openStationRequirements;
window.openAddRequirementModal = openAddRequirementModal;
window.openEditRequirementModal = openEditRequirementModal;
window.submitRequirementModal = submitRequirementModal;
window.deleteRequirement = deleteRequirement;
window.openModelDetail = openModelDetail;
window.closeModelDetail = closeModelDetail;
window.showTab = showTab;
window.mmLoadModelList = mmLoadModelList;
