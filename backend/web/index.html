<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- favicon 放在 /usr/share/nginx/html/favicon.ico -->
  <link rel="icon" href="/favicon.ico" type="image/x-icon">

  <title>治具管理系統</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- 本地 CSS：對應 /usr/share/nginx/html/css/app-main.css -->
  <link rel="stylesheet" href="/css/app-main.css">
</head>


<body class="bg-gray-50 text-gray-900">
        <!-- 登入介面 -->
      <div id="loginModal" class="modal-backdrop">
        <div class="modal space-y-4">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold text-lg">登入</h3>
            <!-- 使用 app-auth.js 的 closeLogin() -->
            <button class="btn btn-ghost text-xs" onclick="closeLogin()">關閉</button>
          </div>
          <div class="grid gap-3">
            <div class="field">
              <label class="label-xs">帳號</label>
              <input id="loginId" class="input" placeholder="輸入帳號" />
            </div>
            <div class="field">
              <label class="label-xs">密碼</label>
              <input id="loginPwd" type="password" class="input" placeholder="輸入密碼" />
            </div>
            <button class="btn btn-primary" onclick="doLogin()">登入</button>
            <p id="loginMsg" class="text-xs text-gray-500"></p>
          </div>
        </div>
      </div>
        <!-- 客戶選擇視窗 -->
        <dialog id="customerSelectModal" class="modal">
          <div class="modal-box space-y-4">
            <h3 class="font-semibold text-lg">請選擇客戶</h3>

            <select id="customerSelect" class="select select-bordered w-full">
              <option value="" disabled selected>請選擇客戶</option>
            </select>

            <div class="flex justify-end gap-2">
              <button class="btn" onclick="confirmCustomerSelection()">確認</button>
            </div>
          </div>
        </dialog>

      <!-- 頂部導覽 -->
        <header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-gray-200">
        <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="h-8 w-8 rounded-xl bg-gray-900 text-white grid place-items-center font-bold">F</div>
            <div>
              <h1 class="text-lg font-semibold leading-tight">治具管理系統</h1>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <span class="pill border-gray-300" id="clock">--:--</span>
            <span id="currentUserDisplay" class="text-xs text-gray-600">未登入</span>

            <!-- 登入按鈕 -->
            <button class="btn btn-ghost" id="btnLogin" onclick="showLoginModal()">登入</button>

            <!-- 登出按鈕（預設隱藏） -->
            <button class="btn btn-ghost hidden" id="btnLogout" onclick="doLogout()">登出</button>
          </div>
        </div>
      </header>


  <!-- 主容器 -->
  <main class="mx-auto max-w-7xl p-4 md:p-6 space-y-6">
    <!-- 功能分頁 -->
    <nav class="grid grid-cols-2 md:grid-cols-7 gap-2">
      <button data-tab="dashboard" class="tab tab-active">儀表板</button>
      <button data-tab="receipts"  class="tab">收料/退料登記</button>
      <button data-tab="query"    class="tab">治具/機種查詢</button>
      <button data-tab="logs"     class="tab">使用/更換記錄</button>
      <button data-tab="stats"    class="tab">治具情況統計</button>
      <button data-tab="admin"    class="tab">後台管理</button>
    </nav>

    <!-- 當前切頁標題欄 -->
    <div id="activeTabBanner" class="card px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-8 w-1.5 rounded-full bg-gray-900"></div>
        <div class="section-title" id="activeTabTitle">儀表板</div>
      </div>
    </div>

    <!-- 儀表板 -->
    <section id="tab-dashboard" class="space-y-6">
      <div class="grid md:grid-cols-3 gap-4">
        <div class="card p-5">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">今日收料</h3>
            <span class="pill border-green-300 text-green-700 bg-green-50">即時</span>
          </div>
          <p class="text-3xl font-bold mt-2" id="todayIn">0</p>
          <div class="mt-3 space-y-2" id="todayInList"></div>
        </div>
        <div class="card p-5">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">今日退料</h3>
            <span class="pill border-blue-300 text-blue-700 bg-blue-50">即時</span>
          </div>
          <p class="text-3xl font-bold mt-2" id="todayOut">0</p>
          <div class="mt-3 space-y-2" id="todayOutList"></div>
        </div>
        <div class="card p-5">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">即將更換治具</h3>
            <button class="btn btn-ghost text-xs" onclick="downloadCSV('upcoming.csv', mockUpcomingCSV())">匯出</button>
          </div>
          <div class="mt-3 space-y-2 max-h-40 overflow-auto" id="upcomingList"></div>
        </div>
      </div>

      <div class="card p-5">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold">庫存概覽</h3>
          <div class="flex items-center gap-2">
            <input id="searchDash" class="w-48 border rounded-xl px-3 py-1.5 text-sm" placeholder="搜尋治具/機種..." />
            <button class="btn btn-ghost text-sm" onclick="filterDashboard()">篩選</button>
          </div>
        </div>
        <div class="overflow-auto">
          <table class="min-w-full text-sm">
            <thead class="text-left text-gray-500">
              <tr>
                <th class="py-2 pr-4">治具編號</th>
                <th class="py-2 pr-4">名稱</th>
                <th class="py-2 pr-4">機種</th>
                <th class="py-2 pr-4">儲位</th>
                <th class="py-2 pr-4">狀態</th>
                <th class="py-2 pr-4">使用次數/週期</th>
                <th class="py-2 pr-4">負責人</th>
              </tr>
            </thead>
            <tbody id="dashTable"></tbody>
          </table>
        </div>
      </div>
    </section>

       <!-- 收料 / 退料 -->
    <section id="tab-receipts" class="hidden space-y-4">

      <!-- 子分頁 -->
      <div class="flex gap-2">
        <button class="subtab subtab-active" data-rtab="receipts">收料登記</button>
        <button class="subtab" data-rtab="returns">退料登記</button>
      </div>

      <!-- ============================================================= -->
      <!-- 🔵 收料 TAB -->
      <!-- ============================================================= -->
      <div id="rtab-receipts" class="space-y-4">

        <div class="card p-5 space-y-4">
          <h3 class="font-semibold text-lg">收料登記</h3>

          <!-- 查詢 -->
          <div class="grid md:grid-cols-6 gap-3">
            <div class="field">
              <label class="label-xs">治具編號</label>
              <input id="receiptSearchFixture" class="input" placeholder="治具編號">
            </div>

            <div class="field">
              <label class="label-xs">單號</label>
              <input id="receiptSearchOrder" class="input" placeholder="單號">
            </div>

            <div class="field">
              <label class="label-xs">客戶</label>
              <input id="receiptSearchVendor" class="input" placeholder="客戶">
            </div>

            <div class="field">
              <label class="label-xs">操作人員</label>
              <input id="receiptSearchOperator" class="input" placeholder="員工號">
            </div>

            <div class="field">
              <label class="label-xs">序號</label>
              <input id="receiptSearchSerial" class="input" placeholder="序號">
            </div>


            <div class="flex items-end">
              <button class="btn btn-primary w-full" onclick="loadReceipts()">查詢</button>
            </div>
          </div>

          <!-- 新增 / 匯入按鈕 -->
          <div class="flex gap-2 flex-wrap">
            <button class="btn btn-primary" onclick="document.getElementById('receiptAddForm').classList.toggle('hidden')">
                新增收料記錄</button>

            <label class="btn btn-ghost cursor-pointer">
              <input id="receiptXlsx" type="file" accept=".xlsx" class="hidden"
                     onchange="handleReceiptImport(this)" />
              匯入 Excel(.xlsx)
            </label>

            <button class="btn btn-ghost" onclick="downloadReceiptTemplate()">下載範本</button>
          </div>

          <!-- 新增表單 -->
          <div id="receiptAddForm" class="hidden border rounded-2xl p-4 bg-gray-50 space-y-3">

            <div class="grid md:grid-cols-5 gap-3">
              <div class="field">
                <label class="label-xs">客戶</label>
                <input id="receiptAddVendor" class="input">
              </div>

              <div class="field">
                <label class="label-xs">單號</label>
                <input id="receiptAddOrder" class="input">
              </div>

              <div class="field">
                <label class="label-xs">治具編號</label>
                <input id="receiptAddFixture" class="input">
              </div>

              <div class="field">
                <label class="label-xs">類型</label>
                <select id="receiptAddType" class="input">
                  <option value="batch">批量（serial_start ~ serial_end）</option>
                  <option value="individual">少量序號（serials）</option>
                </select>
              </div>
            </div>

            <!-- 批量：流水號起訖 -->
            <div id="receiptBatchArea" class="grid md:grid-cols-5 gap-3">
              <div class="field">
                <label class="label-xs">序號起始</label>
                <input id="receiptAddStart" class="input">
              </div>
              <div class="field">
                <label class="label-xs">序號結束</label>
                <input id="receiptAddEnd" class="input">
              </div>
            </div>

            <!-- 少量序號 -->
            <div id="receiptIndividualArea" class="hidden">
              <label class="label-xs">序號（逗號分隔）</label>
              <input id="receiptAddSerials" class="input">
            </div>

            <div class="field">
              <label class="label-xs">備註</label>
              <input id="receiptAddNote" class="input">
            </div>

            <div class="flex justify-end gap-2">
              <button class="btn btn-ghost" onclick="toggleReceiptAdd(false)">取消</button>
              <button class="btn btn-primary" onclick="submitReceipt()">提交</button>
            </div>
          </div>

          <!-- 收料表格 -->
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="text-left text-gray-500">
                <tr>
                  <th class="py-2 pr-4">日期</th>
                  <th class="py-2 pr-4">治具</th>
                  <th class="py-2 pr-4">客戶</th>
                  <th class="py-2 pr-4">單號</th>
                  <th class="py-2 pr-4">來源</th>
                  <th class="py-2 pr-4">序號</th>
                  <th class="py-2 pr-4">操作人員</th>
                  <th class="py-2 pr-4">備註</th>
                  <th class="py-2 pr-4">編輯</th> <!-- ★ 新增 -->
                </tr>
                </thead>
              <tbody id="receiptTable"></tbody>
            </table>
            <div id="receiptPagination" class="flex mt-4 justify-center"></div>
          </div>
        </div>

      </div>

      <!-- ============================================================= -->
      <!-- 🟠 退料 TAB -->
      <!-- ============================================================= -->
      <div id="rtab-returns" class="hidden space-y-4">

        <div class="card p-5 space-y-4">
          <h3 class="font-semibold text-lg">退料登記</h3>

          <!-- 查詢 -->
          <div class="grid md:grid-cols-6 gap-3">
            <div class="field">
              <label class="label-xs">治具編號</label>
              <input id="returnSearchFixture" class="input" placeholder="治具編號">
            </div>

            <div class="field">
              <label class="label-xs">單號</label>
              <input id="returnSearchOrder" class="input" placeholder="單號">
            </div>

            <div class="field">
              <label class="label-xs">客戶</label>
              <input id="returnSearchVendor" class="input" placeholder="客戶">
            </div>

            <div class="field">
              <label class="label-xs">操作人員</label>
              <input id="returnSearchOperator" class="input" placeholder="員工號">
            </div>

            <div class="field">
              <label class="label-xs">序號</label>
              <input id="returnSearchSerial" class="input" placeholder="序號">
            </div>

            <div class="flex items-end">
              <button class="btn btn-primary w-full" onclick="loadReturns()">查詢</button>
            </div>
          </div>

          <!-- 新增 / 匯入 -->
          <div class="flex gap-2 flex-wrap">
            <button class="btn btn-primary" onclick="toggleReturnAdd(true)">新增退料記錄</button>
            <label class="btn btn-ghost cursor-pointer">
              <input id="returnXlsx" type="file" accept=".xlsx" class="hidden"
                     onchange="handleReturnImport(this)" />
              匯入 Excel(.xlsx)
            </label>

            <button class="btn btn-ghost" onclick="downloadReturnTemplate()">下載範本</button>
          </div>

          <!-- 新增表單 -->
          <div id="returnAddForm" class="hidden border rounded-2xl p-4 bg-gray-50 space-y-3">

            <div class="grid md:grid-cols-5 gap-3">
              <div class="field">
                <label class="label-xs">客戶</label>
                <input id="returnAddVendor" class="input">
              </div>

              <div class="field">
                <label class="label-xs">單號</label>
                <input id="returnAddOrder" class="input">
              </div>

              <div class="field">
                <label class="label-xs">治具編號</label>
                <input id="returnAddFixture" class="input">
              </div>

              <div class="field">
                <label class="label-xs">類型</label>
                <select id="returnAddType" class="input">
                  <option value="batch">批量（serial_start ~ serial_end）</option>
                  <option value="individual">少量序號（serials）</option>
                </select>
              </div>
            </div>

            <!-- 批量：流水號起訖 -->
            <div id="returnBatchArea" class="grid md:grid-cols-5 gap-3">
              <div class="field">
                <label class="label-xs">序號起始</label>
                <input id="returnAddStart" class="input">
              </div>
              <div class="field">
                <label class="label-xs">序號結束</label>
                <input id="returnAddEnd" class="input">
              </div>
            </div>

                <!-- 少量序號 -->
                <div id="returnIndividualArea" class="hidden">
                  <label class="label-xs">序號（逗號分隔）</label>
                  <input id="returnAddSerials" class="input">
                </div>

            <div class="field">
              <label class="label-xs">備註</label>
              <input id="returnAddNote" class="input">
            </div>

            <div class="flex justify-end gap-2">
              <button class="btn btn-ghost" onclick="toggleReturnAdd(false)">取消</button>
              <button class="btn btn-primary" onclick="submitReturn()">提交</button>
            </div>
          </div>

          <!-- 退料表格 -->
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="text-left text-gray-500">
                <tr>
                  <th class="py-2 pr-4">日期</th>
                  <th class="py-2 pr-4">治具</th>
                  <th class="py-2 pr-4">客戶</th>
                  <th class="py-2 pr-4">單號</th>
                  <th class="py-2 pr-4">來源</th>
                  <th class="py-2 pr-4">序號</th>
                  <th class="py-2 pr-4">操作人員</th>
                  <th class="py-2 pr-4">備註</th>
                  <th class="py-2 pr-4">編輯</th> <!-- ★ 新增 -->
                </tr>
                </thead>
              <tbody id="returnTable"></tbody>
            </table>
              <div id="returnPagination" class="flex gap-2 mt-3 justify-center"></div>
          </div>
        </div>

      </div>

    </section>

        <!-- 查詢模塊 -->
        <section id="tab-query" class="hidden space-y-4">
          <div class="card p-5 space-y-4">
            <h3 class="font-semibold text-lg">治具／機種查詢</h3>

            <!-- 查詢類型 -->
            <div class="flex gap-4 items-center">
              <label class="font-semibold">查詢類型：</label>
              <select id="queryType" class="input w-60" onchange="switchQueryType()">
                <option value="fixture">治具查詢</option>
                <option value="model">機種查詢</option>
              </select>
            </div>

            <!-- ====================================================== -->
            <!-- 🔵 治具查詢 -->
            <!-- ====================================================== -->
            <div id="fixtureQueryArea" class="space-y-3">

              <div class="flex items-center gap-4 mb-4">
                <div>
                  <span class="query-label">治具搜尋：</span>
                  <input id="fixtureSearch"
                         class="query-input"
                         placeholder="輸入治具編號 / 名稱"
                         oninput="debounceLoadFixtures()">
                </div>

                <div>
                  <span class="query-label">狀態：</span>
                  <select id="fixtureStatus" class="query-input" onchange="loadFixturesQuery()">
                    <option>全部</option>
                    <option>正常</option>
                    <option>維修中</option>
                    <option>報廢</option>
                  </select>
                </div>

                <button onclick="loadFixturesQuery()" class="btn btn-primary">搜尋</button>
              </div>

              <div class="overflow-x-auto border rounded-lg shadow-sm">
                <table class="min-w-full text-sm text-center border-collapse">
                  <thead class="text-gray-700 bg-gray-50 border-b">
                    <tr>
                      <th class="py-2 px-4 w-24">治具編號</th>
                      <th class="py-2 px-4 w-32">名稱</th>
                      <th class="py-2 px-4 w-24">客戶</th>
                      <th class="py-2 px-4 w-32">類型</th>
                      <th class="py-2 px-4 w-44">庫存(自購/客供/總)</th>
                      <th class="py-2 px-4 w-24">狀態</th>
                      <th class="py-2 px-4 w-24">儲位</th>
                      <th class="py-2 px-4 w-32">負責人</th>
                      <th class="py-2 px-4 w-48">備註</th>
                    </tr>
                  </thead>
                  <tbody id="fixtureTable" class="divide-y divide-gray-100 text-gray-800"></tbody>
                </table>

                <div id="fixtureQueryPagination"
                     class="flex gap-2 mt-3 justify-center"></div>
              </div>
            </div>

            <!-- ====================================================== -->
            <!-- 🔵 機種查詢 -->
            <!-- ====================================================== -->
            <div id="modelQueryArea" class="hidden space-y-3">

              <div class="flex gap-3">
                <input id="modelSearch"
                       class="input w-64"
                       placeholder="輸入機種代碼或名稱"
                       oninput="loadModelsQuery()" />

                <button class="btn btn-primary" onclick="loadModelsQuery()">查詢</button>
              </div>

              <div class="overflow-x-auto border rounded-lg shadow-sm">
                <table class="min-w-full text-sm text-center border-collapse">
                  <thead class="text-gray-700 bg-gray-50 border-b">
                    <tr>
                      <th class="py-2 px-4 w-32">機種代碼</th>
                      <th class="py-2 px-4 w-40">名稱</th>
                      <th class="py-2 px-4 w-24">客戶</th>
                      <th class="py-2 px-4 w-64">備註</th>
                      <th class="py-2 px-4 w-24">操作</th>
                    </tr>
                  </thead>
                  <tbody id="modelTable" class="divide-y divide-gray-100 text-gray-800"></tbody>
                </table>

                <div id="modelQueryPagination"
                     class="flex gap-2 mt-3 justify-center"></div>
              </div>

              <!-- ====================================================== -->
              <!-- 三段式 UI：站點綁定 + 治具需求設定 -->
              <!-- ====================================================== -->
              <div id="msNoModelHint"
                   class="text-center text-gray-500 py-5">
                🔍 請先選擇一個機種，才能進行站點綁定與治具需求設定
              </div>

              <div id="msContent" class="hidden grid grid-cols-2 gap-6 mt-4">

                <!-- ====================================================== -->
                <!-- 左側：站點綁定 -->
                <!-- ====================================================== -->
                <div class="space-y-4">

                  <h4 class="font-semibold text-lg">已綁定站點</h4>

                  <div class="overflow-x-auto border rounded-lg shadow-sm">
                    <table class="min-w-full text-sm">
                      <thead class="bg-gray-50 text-gray-600">
                        <tr>
                          <th class="py-2 px-3">站點代碼</th>
                          <th class="py-2 px-3">名稱</th>
                          <th class="py-2 px-3">治具需求</th>
                          <th class="py-2 px-3">操作</th>
                        </tr>
                      </thead>
                      <tbody id="msBoundTable"></tbody>
                    </table>
                  </div>

                  <h4 class="font-semibold text-lg mt-6">可綁定站點</h4>

                  <div class="overflow-x-auto border rounded-lg shadow-sm">
                    <table class="min-w-full text-sm">
                      <thead class="bg-gray-50 text-gray-600">
                        <tr>
                          <th class="py-2 px-3">站點代碼</th>
                          <th class="py-2 px-3">名稱</th>
                          <th class="py-2 px-3">操作</th>
                        </tr>
                      </thead>
                      <tbody id="msAvailableTable"></tbody>
                    </table>
                  </div>
                </div>

                <!-- ====================================================== -->
                <!-- 右側：治具需求設定 -->
                <!-- ====================================================== -->
                <div class="space-y-4">

                  <h4 class="font-semibold text-lg">
                    治具需求設定：<span id="reqStationLabel" class="text-indigo-600"></span>
                  </h4>

                  <!-- 新增治具需求按鈕 -->
                  <button class="btn btn-primary btn-sm"
                          onclick="openRequirementModal('create')">
                    ➕ 新增治具需求
                  </button>

                  <!-- 已設定治具需求 -->
                  <div class="overflow-x-auto border rounded-lg shadow-sm">
                    <table class="min-w-full text-sm">
                      <thead class="bg-gray-50 text-gray-600">
                        <tr>
                          <th class="py-2 px-3">治具 ID</th>
                          <th class="py-2 px-3">名稱</th>
                          <th class="py-2 px-3">需求數</th>
                          <th class="py-2 px-3">備註</th>
                          <th class="py-2 px-3">操作</th>
                        </tr>
                      </thead>
                      <tbody id="reqTable"></tbody>
                    </table>
                  </div>

                </div>
              </div>
            </div>
          </div>
        </section>

<!-- ============================================================ -->
<!-- 🔵 新增 / 編輯治具需求 Modal（共用） -->
<!-- ============================================================ -->
<div id="requirementModal"
     class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50"
     style="display:none;">
  <div class="bg-white rounded-xl shadow-xl p-6 w-[400px] space-y-4">

    <h3 id="reqModalTitle" class="text-lg font-semibold">新增治具需求</h3>

    <!-- 模式：create / edit -->
    <input type="hidden" id="reqModalMode" />
    <input type="hidden" id="reqModalReqId" />

    <!-- create 才顯示 -->
    <div id="reqModalFixtureBlock">
      <label class="text-sm font-medium">治具編號</label>
      <input id="reqModalFixtureId" class="input w-full" placeholder="例如：FIX-001" />
    </div>

    <div>
      <label class="text-sm font-medium">需求數量</label>
      <input id="reqModalRequiredQty" type="number" class="input w-full" />
    </div>

    <div>
      <label class="text-sm font-medium">備註</label>
      <textarea id="reqModalNote" class="input w-full" rows="2"></textarea>
    </div>

    <div class="flex justify-end gap-3">
      <button class="btn btn-ghost" onclick="closeRequirementModal()">取消</button>
      <button class="btn btn-primary" onclick="submitRequirementModal()">確認</button>
    </div>

  </div>
</div>




    <!-- 治具情況統計(新增分頁) -->
    <section id="tab-stats" class="hidden space-y-4">
      <!-- 統計卡片 -->
      <div class="grid md:grid-cols-4 gap-4">
        <div class="card p-5 stat-card">
          <div class="text-sm opacity-90">總治具數量</div>
          <div class="text-3xl font-bold mt-2" id="statTotalFixtures">0</div>
        </div>
        <div class="card p-5 bg-gradient-to-br from-green-400 to-emerald-600 text-white">
          <div class="text-sm opacity-90">正常使用中</div>
          <div class="text-3xl font-bold mt-2" id="statActiveFixtures">0</div>
        </div>
        <div class="card p-5 bg-gradient-to-br from-amber-400 to-orange-600 text-white">
          <div class="text-sm opacity-90">壽命未達標</div>
          <div class="text-3xl font-bold mt-2" id="statUnderLifespan">0</div>
        </div>
        <div class="card p-5 bg-gradient-to-br from-red-400 to-rose-600 text-white">
          <div class="text-sm opacity-90">即將更換</div>
          <div class="text-3xl font-bold mt-2" id="statNeedReplacement">0</div>
        </div>
      </div>

      <!-- 治具壽命管理作法 -->
      <div class="card p-5 space-y-4">
        <h3 class="font-semibold text-lg">治具壽命管理作法(針對不耐用治具)</h3>

        <div class="grid md:grid-cols-2 gap-4">
          <!-- 1. 建立壽命比對機制 -->
          <div class="border rounded-xl p-4 space-y-3">
            <div class="flex items-center gap-2">
              <div class="h-8 w-8 rounded-lg bg-blue-100 text-blue-700 grid place-items-center font-bold">1</div>
              <h4 class="font-semibold">建立壽命比對機制</h4>
            </div>
            <ul class="text-sm text-gray-600 space-y-2 ml-10">
              <li>• 每個治具設定預期壽命(次數或天數)</li>
              <li>• 系統記錄實際使用次數</li>
              <li>• 未達標自動標示「壽命未達預設值」</li>
            </ul>
          </div>

          <!-- 2. 自動分類與標示 -->
          <div class="border rounded-xl p-4 space-y-3">
            <div class="flex items-center gap-2">
              <div class="h-8 w-8 rounded-lg bg-green-100 text-green-700 grid place-items-center font-bold">2</div>
              <h4 class="font-semibold">自動分類與標示</h4>
            </div>
            <ul class="text-sm text-gray-600 space-y-2 ml-10">
              <li>• 系統自動歸類「不耐用治具」清單</li>
              <li>• 顯示紅色警示</li>
              <li>• 儀表板可統計比例</li>
            </ul>
          </div>

          <!-- 3. 原因分析與回報 -->
          <div class="border rounded-xl p-4 space-y-3">
            <div class="flex items-center gap-2">
              <div class="h-8 w-8 rounded-lg bg-amber-100 text-amber-700 grid place-items-center font-bold">3</div>
              <h4 class="font-semibold">原因分析與回報</h4>
            </div>
            <ul class="text-sm text-gray-600 space-y-2 ml-10">
              <li>• 報廢時填寫損壞原因、使用環境</li>
              <li>• 可上傳照片</li>
              <li>• 供工程部分析設計問題</li>
            </ul>
          </div>

          <!-- 4. 系統提醒與學習回饋 -->
          <div class="border rounded-xl p-4 space-y-3">
            <div class="flex items-center gap-2">
              <div class="h-8 w-8 rounded-lg bg-purple-100 text-purple-700 grid place-items-center font-bold">4</div>
              <h4 class="font-semibold">系統提醒與學習回饋</h4>
            </div>
            <ul class="text-sm text-gray-600 space-y-2 ml-10">
              <li>• 若同型號多次壽命不足</li>
              <li>• 自動提醒檢討</li>
              <li>• 持續優化治具設計</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- 不耐用治具清單 -->
      <div class="card p-5 space-y-4">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">不耐用治具清單(壽命未達預設值)</h3>
          <button class="btn btn-ghost text-sm" onclick="downloadCSV('undurable_fixtures.csv', toCSV(getUndurableFixtures()))">匯出清單</button>
        </div>
        <div class="overflow-auto">
          <table class="min-w-full text-sm">
            <thead class="text-left text-gray-500">
              <tr>
                <th class="py-2 pr-4">治具編號</th>
                <th class="py-2 pr-4">名稱</th>
                <th class="py-2 pr-4">預期壽命</th>
                <th class="py-2 pr-4">實際使用</th>
                <th class="py-2 pr-4">達成率</th>
                <th class="py-2 pr-4">警示等級</th>
                <th class="py-2 pr-4">負責人</th>
                <th class="py-2 pr-4">操作</th>
              </tr>
            </thead>
            <tbody id="undurableTable"></tbody>
          </table>
        </div>
      </div>

      <!-- 報廢原因登記表單 -->
      <div class="card p-5 space-y-4">
        <h3 class="font-semibold">報廢原因登記</h3>
        <div class="grid md:grid-cols-6 gap-3">
          <div class="field"><label class="label-xs">治具編號</label><select id="scrapFixture" class="input"></select></div>
          <div class="field"><label class="label-xs">報廢日期</label><input id="scrapDate" type="date" class="input" /></div>
          <div class="field"><label class="label-xs">損壞原因</label>
            <select id="scrapReason" class="input">
              <option>正常磨損</option>
              <option>材質問題</option>
              <option>設計缺陷</option>
              <option>操作不當</option>
              <option>意外損壞</option>
              <option>其他</option>
            </select>
          </div>
          <div class="field"><label class="label-xs">使用環境</label><input id="scrapEnv" class="input" placeholder="如:高溫/潮濕" /></div>
          <div class="field"><label class="label-xs">照片上傳</label><input id="scrapPhoto" type="file" accept="image/*" class="input text-xs" /></div>
          <div class="flex items-end"><button class="btn btn-primary w-full" onclick="toast('已記錄報廢原因')">提交</button></div>
        </div>
        <div class="field">
          <label class="label-xs">詳細說明</label>
          <textarea id="scrapNote" class="input" rows="2" placeholder="請詳細描述損壞情況..."></textarea>
        </div>
      </div>
    </section>

       <!-- 使用 / 更換記錄 -->
    <section id="tab-logs" class="hidden space-y-4">

      <!-- 子分頁 -->
      <div class="flex gap-2">
        <button class="subtab subtab-active" data-logtab="usage">使用記錄</button>
        <button class="subtab" data-logtab="replacement">更換記錄</button>
      </div>

      <!-- ================================ -->
      <!-- 🔵 使用記錄 TAB -->
      <!-- ================================ -->
      <div id="logtab-usage" class="space-y-4">

        <div class="card p-5 space-y-4">
          <h3 class="font-semibold text-lg">使用記錄</h3>

          <!-- 查詢區 -->
          <div class="grid md:grid-cols-6 gap-3">
            <div class="field">
              <label class="label-xs">治具</label>
              <input id="usageSearchFixture" class="input" placeholder="治具編號" />
            </div>
            <div class="field">
              <label class="label-xs">站點 ID</label>
              <input id="usageSearchStation" class="input" type="number" placeholder="站點 ID" />
            </div>
            <div class="field">
              <label class="label-xs">操作人員</label>
              <input id="usageSearchOperator" class="input" placeholder="員工號" />
            </div>
            <div class="field">
              <label class="label-xs">日期起</label>
              <input id="usageSearchFrom" type="datetime-local" class="input" />
            </div>
            <div class="field">
              <label class="label-xs">日期迄</label>
              <input id="usageSearchTo" type="datetime-local" class="input" />
            </div>
            <div class="flex items-end">
              <button class="btn btn-primary w-full" onclick="loadUsageLogs()">查詢</button>
            </div>
          </div>

          <!-- 新增 / 批量 / 匯入按鈕 -->
          <div class="flex gap-2 flex-wrap">
            <button class="btn btn-primary" onclick="toggleUsageAdd(true)">新增使用記錄</button>

            <label class="btn btn-ghost cursor-pointer">
              <input id="usageXlsx" type="file" accept=".xlsx" class="hidden"
                     onchange="handleUsageImport(this)" />
              匯入 Excel(.xlsx)
            </label>

            <button class="btn btn-ghost" onclick="downloadUsageTemplate()">下載範本</button>
          </div>

          <!-- 新增表單 -->
          <div id="usageAddForm" class="hidden border rounded-2xl p-4 bg-gray-50 space-y-3">

            <div class="grid md:grid-cols-6 gap-3">
              <div class="field">
                <label class="label-xs">治具編號</label>
                <input id="usageAddFixture" class="input" />
              </div>

              <div class="field">
                <label class="label-xs">站點 ID</label>
                <input id="usageAddStation" class="input" type="number" />
              </div>

              <div class="field">
                <label class="label-xs">使用次數</label>
                <input id="usageAddCount" type="number" class="input" value="1" />
              </div>

              <div class="field">
                <label class="label-xs">異常狀態</label>
                <input id="usageAddAbnormal" class="input" />
              </div>

              <div class="field">
                <label class="label-xs">操作人員</label>
                <input id="usageAddOperator" class="input" />
              </div>

              <div class="field">
                <label class="label-xs">使用時間</label>
                <input id="usageAddTime" type="datetime-local" class="input" />
              </div>
            </div>

            <div class="field">
              <label class="label-xs">備註</label>
              <input id="usageAddNote" class="input" />
            </div>

            <div class="grid md:grid-cols-6 gap-3">
              <div class="field">
                <label class="label-xs">批量筆數（如不批量留空）</label>
                <input id="usageAddBatch" type="number" class="input" />
              </div>
            </div>

            <div class="flex justify-end gap-2">
              <button class="btn btn-ghost" onclick="toggleUsageAdd(false)">取消</button>
              <button class="btn btn-primary" onclick="submitUsageLog()">提交</button>
            </div>
          </div>

          <!-- 使用記錄表格 -->
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="text-left text-gray-500">
              <tr>
                <th class="py-2 pr-4">日期</th>
                <th class="py-2 pr-4">治具</th>
                <th class="py-2 pr-4">站點</th>
                <th class="py-2 pr-4">次數</th>
                <th class="py-2 pr-4">異常</th>
                <th class="py-2 pr-4">操作人員</th>
                <th class="py-2 pr-4">備註</th>
                <th class="py-2 pr-4">刪除</th>
              </tr>
              </thead>
              <tbody id="usageTable"></tbody>
            </table>
          </div>

        </div>
      </div>

      <!-- ================================ -->
      <!-- 🟠 更換記錄 TAB -->
      <!-- ================================ -->
      <div id="logtab-replacement" class="hidden space-y-4">

        <div class="card p-5 space-y-4">
          <h3 class="font-semibold text-lg">更換記錄</h3>

          <!-- 查詢 -->
          <div class="grid md:grid-cols-6 gap-3">
            <div class="field">
              <label class="label-xs">治具</label>
              <input id="replaceSearchFixture" class="input" />
            </div>
            <div class="field">
              <label class="label-xs">執行人員</label>
              <input id="replaceSearchExec" class="input" />
            </div>
            <div class="field">
              <label class="label-xs">更換日期起</label>
              <input id="replaceSearchFrom" type="date" class="input" />
            </div>
            <div class="field">
              <label class="label-xs">更換日期迄</label>
              <input id="replaceSearchTo" type="date" class="input" />
            </div>
            <div class="flex items-end">
              <button class="btn btn-primary w-full" onclick="loadReplacementLogs()">查詢</button>
            </div>
          </div>

          <!-- 新增 / 批量 / 匯入 -->
          <div class="flex gap-2 flex-wrap">
            <button class="btn btn-primary" onclick="toggleReplaceAdd(true)">新增更換記錄</button>

            <label class="btn btn-ghost cursor-pointer">
              <input id="replaceXlsx" type="file" accept=".xlsx" class="hidden"
                     onchange="handleReplaceImport(this)" />
              匯入 Excel(.xlsx)
            </label>

            <button class="btn btn-ghost" onclick="downloadReplaceTemplate()">下載範本</button>
          </div>

          <!-- 新增表單 -->
          <div id="replaceAddForm" class="hidden border rounded-2xl p-4 bg-gray-50 space-y-3">

            <div class="grid md:grid-cols-5 gap-3">
              <div class="field">
                <label class="label-xs">治具編號</label>
                <input id="replaceAddFixture" class="input" />
              </div>
              <div class="field">
                <label class="label-xs">更換日期</label>
                <input id="replaceAddDate" type="date" class="input" />
              </div>
              <div class="field">
                <label class="label-xs">原因</label>
                <input id="replaceAddReason" class="input" />
              </div>
              <div class="field">
                <label class="label-xs">執行人員</label>
                <input id="replaceAddExecutor" class="input" />
              </div>
            </div>

            <div class="field">
              <label class="label-xs">備註</label>
              <input id="replaceAddNote" class="input" />
            </div>

            <div class="grid md:grid-cols-5 gap-3">
              <div class="field">
                <label class="label-xs">批量筆數（如不批量留空）</label>
                <input id="replaceAddBatch" type="number" class="input" />
              </div>
            </div>

            <div class="flex justify-end gap-2">
              <button class="btn btn-ghost" onclick="toggleReplaceAdd(false)">取消</button>
              <button class="btn btn-primary" onclick="submitReplacementLog()">提交</button>
            </div>
          </div>

          <!-- 表格 -->
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="text-left text-gray-500">
              <tr>
                <th class="py-2 pr-4">日期</th>
                <th class="py-2 pr-4">治具</th>
                <th class="py-2 pr-4">原因</th>
                <th class="py-2 pr-4">執行人員</th>
                <th class="py-2 pr-4">備註</th>
                <th class="py-2 pr-4">刪除</th>
              </tr>
              </thead>
              <tbody id="replaceTable"></tbody>
            </table>
          </div>

        </div>
      </div>

    </section>


    <!-- 後台管理(新增:子頁層) -->
    <section id="tab-admin" class="hidden space-y-4">
      <!-- 子頁層 -->
      <div class="flex flex-wrap gap-2">
        <button class="tab subtab-active" data-subtab="acct">帳號與權限</button>
        <button class="tab" data-subtab="smtp">SMTP 設定</button>
        <button class="tab" data-subtab="fixture">治具資料維護</button>
        <button class="tab" data-subtab="model">機種資料維護</button>
      </div>

      <!-- 帳號與權限 -->
      <div id="subtab-acct" class="card p-5 space-y-4">
        <h3 class="font-semibold">帳號與權限</h3>
        <div class="grid md:grid-cols-3 gap-4">
          <!-- 新增帳戶 -->
          <div class="border rounded-2xl p-4 space-y-3">
            <div class="font-semibold text-sm">新增帳戶</div>
            <div class="grid gap-3">
              <div class="field"><label class="label-xs">帳號 (id)</label><input id="accAddId" class="input"/></div>
              <div class="field"><label class="label-xs">密碼</label><input id="accAddPwd" type="password" class="input"/></div>
              <div class="field"><label class="label-xs">Email</label><input id="accAddMail" type="email" class="input"/></div>
              <div class="field"><label class="label-xs">權限</label>
                <select id="accAddRole" class="input">
                  <option value="user">一般用戶(查詢/增加)</option>
                  <option value="admin">管理員(查詢/增修刪)</option>
                </select>
              </div>
              <button class="btn btn-primary" onclick="toast('已新增帳戶(模擬)')">新增</button>
            </div>
          </div>

          <!-- 刪除帳戶 -->
          <div class="border rounded-2xl p-4 space-y-3">
            <div class="font-semibold text-sm">刪除帳戶</div>
            <div class="grid gap-3">
              <div class="field"><label class="label-xs">帳號 (id)</label><input id="accDelId" class="input"/></div>
              <div class="field"><label class="label-xs">密碼</label><input id="accDelPwd" type="password" class="input"/></div>
              <button class="btn btn-ghost" onclick="toast('已刪除帳戶(模擬)')">刪除</button>
            </div>
          </div>

          <!-- 修改密碼 -->
          <div class="border rounded-2xl p-4 space-y-3">
            <div class="font-semibold text-sm">修改密碼</div>
            <div class="grid gap-3">
              <div class="field"><label class="label-xs">帳號 (id)</label><input id="accModId" class="input"/></div>
              <div class="field"><label class="label-xs">現行密碼</label><input id="accModPwd" type="password" class="input"/></div>
              <div class="field"><label class="label-xs">新密碼</label><input id="accModNew" type="password" class="input"/></div>
              <div class="field"><label class="label-xs">Email</label><input id="accModMail" type="email" class="input"/></div>
              <button class="btn btn-ghost" onclick="toast('已修改密碼(模擬)')">修改</button>
            </div>
          </div>
        </div>
      </div>

      <!-- SMTP 設定(含更換通知對象) -->
      <div id="subtab-smtp" class="card p-5 space-y-4 hidden">
        <h3 class="font-semibold">SMTP 設定</h3>
        <div class="grid md:grid-cols-3 gap-3">
          <div class="field"><label class="label-xs">Email</label><input id="smtpEmail" class="input" placeholder="通知寄送 Email"/></div>
          <div class="field"><label class="label-xs">外送郵件伺服器名稱 (SMTP)</label><input id="smtpHost" class="input" placeholder="smtp.example.com"/></div>
          <div class="field"><label class="label-xs">埠號 (Port)</label><input id="smtpPort" class="input" placeholder="587"/></div>
          <div class="field"><label class="label-xs">認證狀態</label>
            <select id="smtpAuthState" class="input">
              <option>未認證</option><option>已認證</option>
            </select>
          </div>
          <div class="field"><label class="label-xs">認證帳號</label><input id="smtpUser" class="input" /></div>
          <div class="field"><label class="label-xs">認證密碼</label><input id="smtpPass" type="password" class="input" /></div>
          <div class="field"><label class="label-xs">寄件者名稱</label><input id="smtpSenderName" class="input" /></div>
          <div class="field"><label class="label-xs">寄件者信箱</label><input id="smtpSenderMail" type="email" class="input" /></div>
        </div>
        <div class="flex gap-2">
          <button class="btn btn-primary" onclick="toast('已儲存 SMTP(模擬)')">儲存</button>
          <button class="btn btn-ghost" onclick="toast('測試寄信(模擬)')">測試寄信</button>
        </div>

        <div class="pt-2 border-t">
          <div class="flex items-center justify-between py-3">
            <h4 class="font-semibold">更換通知對象</h4>
            <button class="btn btn-ghost" onclick="downloadCSV('owners.csv', toCSV(mockOwners))">匯出負責人</button>
          </div>
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="text-left text-gray-500">
                <tr><th class="py-2 pr-4">員編</th><th class="py-2 pr-4">姓名</th><th class="py-2 pr-4">Email</th><th class="py-2 pr-4">操作</th></tr>
              </thead>
              <tbody id="ownerTable"></tbody>
            </table>
          </div>
        </div>
      </div>

            <!-- 治具資料維護 -->
      <div id="subtab-fixture" class="card p-5 space-y-3 hidden">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">治具資料維護</h3>
          <div class="flex items-center gap-2">
            <button class="btn btn-ghost" onclick="exportFixturesCsv()">匯出</button>
            <button class="btn btn-ghost" onclick="downloadCSV('fixtures_template.csv', fixtureTemplate())">下載範本</button>
            <label class="btn btn-ghost cursor-pointer">
              <input id="fxCsv" type="file" accept=".xlsx,.csv" class="hidden" onchange="handleFixtureCsv(this)" />
              匯入 Excel/CSV
            </label>
            <button class="btn btn-primary" onclick="openFixtureModal('create')">新增治具</button>
          </div>
        </div>

        <!-- 篩選條件 -->
        <div class="grid md:grid-cols-5 gap-3">
          <div class="field">
            <label class="label-xs">關鍵字</label>
            <input id="fxSearch" class="input" placeholder="治具編號 / 名稱" onkeydown="if(event.key==='Enter'){fxPage=1;loadFixtureList();}" />
          </div>
          <div class="field">
            <label class="label-xs">狀態</label>
            <select id="fxStatusFilter" class="input" onchange="fxPage=1;loadFixtureList();">
              <option value="">全部</option>
              <option value="正常">正常</option>
              <option value="返還">返還</option>
              <option value="報廢">報廢</option>
            </select>
          </div>
          <div class="field">
            <label class="label-xs">負責人 (owner_id)</label>
            <input id="fxOwnerFilter" class="input" placeholder="ID (選填，可留空)" onkeydown="if(event.key==='Enter'){fxPage=1;loadFixtureList();}" />
          </div>
          <div class="field">
            <label class="label-xs">每頁筆數</label>
            <select id="fxPageSize" class="input" onchange="fxPage=1;loadFixtureList();">
              <option value="8">8</option>
              <option value="20">20</option>
              <option value="50">50</option>
            </select>
          </div>
          <div class="field flex items-end">
            <button class="btn btn-ghost w-full" onclick="fxPage=1;loadFixtureList();">重新整理</button>
          </div>
        </div>

        <!-- 列表 + 分頁 -->
        <div class="border-t pt-3">
          <div class="flex items-center justify-between">
            <div class="text-sm text-gray-600">
              共 <span id="fxCount">0</span> 筆，
              顯示第 <span id="fxPageNow">1</span> / <span id="fxPageMax">1</span> 頁
            </div>
            <div class="pagination flex items-center gap-2">
              <button class="btn btn-ghost text-xs" onclick="goFixturePage('first')">«</button>
              <button class="btn btn-ghost text-xs" onclick="goFixturePage('prev')">上一頁</button>
              <button class="btn btn-ghost text-xs" onclick="goFixturePage('next')">下一頁</button>
              <button class="btn btn-ghost text-xs" onclick="goFixturePage('last')">»</button>
            </div>
          </div>

          <div class="overflow-auto mt-2">
            <table class="min-w-full text-xs md:text-sm">
              <thead class="text-left text-gray-500">
                <tr>
                  <th class="py-2 pr-4">治具編號</th>
                  <th class="py-2 pr-4">治具名稱</th>
                  <th class="py-2 pr-4">類型</th>
                  <th class="py-2 pr-4">自購 / 客供 / 總數</th>
                  <th class="py-2 pr-4">儲位</th>
                  <th class="py-2 pr-4">狀態</th>
                  <th class="py-2 pr-4">更換週期</th>
                  <th class="py-2 pr-4">負責人</th>
                  <th class="py-2 pr-4">備註</th>
                  <th class="py-2 pr-4">操作</th>
                </tr>
              </thead>
              <tbody id="fxTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- 治具 新增/編輯 Modal -->
      <div id="fixtureModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm items-center justify-center hidden z-40">
        <div class="bg-white rounded-2xl shadow-xl max-w-3xl w-full mx-4 p-5 space-y-4">
          <div class="flex items-center justify-between">
            <h3 id="fixtureModalTitle" class="font-semibold text-lg">新增治具</h3>
            <button class="btn btn-ghost text-sm" onclick="closeFixtureModal()">✕</button>
          </div>

          <form id="fixtureForm" class="space-y-3" onsubmit="submitFixtureForm(event)">
            <div class="grid md:grid-cols-3 gap-3">
              <div class="field">
                <label class="label-xs">治具編號 (fixture_id)</label>
                <input id="fmFixtureId" class="input" placeholder="L-00017" />
              </div>
              <div class="field">
                <label class="label-xs">治具名稱</label>
                <input id="fmFixtureName" class="input" placeholder="主板測試治具 A" />
              </div>
              <div class="field">
                <label class="label-xs">治具類型</label>
                <input id="fmFixtureType" class="input" placeholder="測試治具" />
              </div>
            </div>

            <div class="grid md:grid-cols-4 gap-3">
              <div class="field">
                <label class="label-xs">序號 (serial_number)</label>
                <input id="fmSerialNumber" class="input" placeholder="SN2025..." />
              </div>
              <div class="field">
                <label class="label-xs">自購數量</label>
                <input id="fmSelfQty" type="number" min="0" class="input" />
              </div>
              <div class="field">
                <label class="label-xs">客供數量</label>
                <input id="fmCustomerQty" type="number" min="0" class="input" />
              </div>
              <div class="field">
                <label class="label-xs">儲存位置</label>
                <input id="fmStorage" class="input" placeholder="倉庫 A-01" />
              </div>
            </div>

            <div class="grid md:grid-cols-4 gap-3">
              <div class="field">
                <label class="label-xs">更換週期 (數值)</label>
                <input id="fmCycle" type="number" min="0" step="0.01" class="input" />
              </div>
              <div class="field">
                <label class="label-xs">週期單位 (cycle_unit)</label>
                <select id="fmCycleUnit" class="input">
                  <option value="uses">使用次數</option>
                  <option value="days">天數</option>
                  <option value="none">無</option>
                </select>
              </div>
              <div class="field">
                <label class="label-xs">狀態</label>
                <select id="fmStatus" class="input">
                  <option value="正常">正常</option>
                  <option value="返還">返還</option>
                  <option value="報廢">報廢</option>
                </select>
              </div>
              <div class="field">
                <label class="label-xs">負責人 ID (owner_id)</label>
                <input id="fmOwnerId" type="number" min="0" class="input" />
              </div>
            </div>

            <div class="field">
              <label class="label-xs">備註</label>
              <textarea id="fmNote" class="input" rows="2"></textarea>
            </div>

            <div class="flex items-center justify-end gap-2 pt-2 border-t">
              <button type="button" class="btn btn-ghost" onclick="closeFixtureModal()">取消</button>
              <button type="submit" class="btn btn-primary">儲存</button>
            </div>
          </form>
        </div>
      </div>


      <!-- 機種資料維護（三段式） -->
      <div id="subtab-model" class="card p-5 space-y-3 hidden">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">機種資料維護（三段式）</h3>
          <div class="flex items-center gap-2">
            <button class="btn btn-ghost" onclick="mmExportModelsCsv()">匯出機種</button>
            <button class="btn btn-primary" onclick="mmOpenModelModal('create')">新增機種</button>
          </div>
        </div>

        <!-- 三欄 Layout -->
        <div class="grid md:grid-cols-3 gap-3 mt-2">
          <!-- 左：機種清單 -->
          <div class="border rounded-2xl p-3 flex flex-col gap-2">
            <div class="flex items-center justify-between gap-2">
              <div class="font-semibold text-sm">機種清單</div>
            </div>
            <div class="field">
              <label class="label-xs">搜尋</label>
              <input id="mmSearch" class="input" placeholder="輸入機種代碼/名稱" onkeydown="if(event.key==='Enter'){ mmLoadModelList(); }" />
            </div>
            <button class="btn btn-ghost btn-xs self-start" onclick="mmLoadModelList()">重新整理</button>
            <div class="text-xs text-gray-500">共 <span id="mmCount">0</span> 筆</div>
            <div class="overflow-auto border rounded-xl max-h-72">
              <table class="min-w-full text-xs">
                <thead class="bg-gray-50 text-gray-500">
                  <tr>
                    <th class="py-1.5 px-2 text-left">機種代碼</th>
                    <th class="py-1.5 px-2 text-left">機種名稱</th>
                    <th class="py-1.5 px-2 text-left">操作</th>
                  </tr>
                </thead>
                <tbody id="mmTable"></tbody>
              </table>
            </div>
          </div>

          <!-- 中：機種 ↔ 站點 綁定 + 站點 CRUD -->
          <div class="border rounded-2xl p-3 flex flex-col gap-2">
            <div class="flex items-center justify-between gap-2">
              <div class="font-semibold text-sm">
                機種站點綁定
                <span id="msSelectedModelLabel" class="text-xs text-gray-500"></span>
              </div>
              <button class="btn btn-ghost btn-xs" onclick="stOpenStationMasterModal()">站點主檔維護</button>
            </div>

            <div id="msNoModelHint" class="text-xs text-gray-500">
              請先在左側選擇一個機種。
            </div>

            <div id="msContent" class="space-y-2 hidden">
              <!-- 已綁定站點 -->
              <div>
                <div class="flex items-center justify-between">
                  <div class="text-xs font-semibold">已綁定站點</div>
                  <button class="btn btn-ghost btn-xs" onclick="msReloadForCurrentModel()">重新整理</button>
                </div>
                <div class="overflow-auto border rounded-xl max-h-32 mt-1">
                  <table class="min-w-full text-xs">
                    <thead class="bg-gray-50 text-gray-500">
                      <tr>
                        <th class="py-1 px-2 text-left">代碼</th>
                        <th class="py-1 px-2 text-left">名稱</th>
                        <th class="py-1 px-2 text-left">操作</th>
                      </tr>
                    </thead>
                    <tbody id="msBoundTable"></tbody>
                  </table>
                </div>
              </div>

              <!-- 可綁定站點 -->
              <div>
                <div class="flex items-center justify-between">
                  <div class="text-xs font-semibold">可綁定站點</div>
                </div>
                <div class="overflow-auto border rounded-xl max-h-32 mt-1">
                  <table class="min-w-full text-xs">
                    <thead class="bg-gray-50 text-gray-500">
                      <tr>
                        <th class="py-1 px-2 text-left">代碼</th>
                        <th class="py-1 px-2 text-left">名稱</th>
                        <th class="py-1 px-2 text-left">操作</th>
                      </tr>
                    </thead>
                    <tbody id="msAvailableTable"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- 右：治具需求 -->
          <div class="border rounded-2xl p-3 flex flex-col gap-2">
            <div class="font-semibold text-sm">
              治具需求設定
              <div class="text-xs text-gray-500">
                機種：<span id="frSelectedModelLabel">-</span> /
                站點：<span id="frSelectedStationLabel">-</span>
              </div>
            </div>

            <div id="frNoModelStationHint" class="text-xs text-gray-500">
              請先選擇左側機種，再在中間選擇一個「已綁定站點」。
            </div>

            <div id="frContent" class="space-y-2 hidden">
              <!-- 新增治具需求 -->
              <div class="grid grid-cols-5 gap-2 items-end">
                <div class="col-span-3 field">
                  <label class="label-xs">治具</label>
                  <select id="frFixtureSelect" class="input">
                    <option value="">選擇治具...</option>
                  </select>
                </div>
                <div class="col-span-1 field">
                  <label class="label-xs">需求數量</label>
                  <input id="frQtyInput" type="number" min="1" class="input" value="1" />
                </div>
                <div class="col-span-1">
                  <button class="btn btn-primary w-full" onclick="frAddRequirement()">新增</button>
                </div>
              </div>

              <!-- 需求清單 -->
              <div class="overflow-auto border rounded-xl max-h-64 mt-1">
                <table class="min-w-full text-xs">
                  <thead class="bg-gray-50 text-gray-500">
                    <tr>
                      <th class="py-1 px-2 text-left">治具編號</th>
                      <th class="py-1 px-2 text-left">治具名稱</th>
                      <th class="py-1 px-2 text-left">需求數量</th>
                      <th class="py-1 px-2 text-left">操作</th>
                    </tr>
                  </thead>
                  <tbody id="frTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 機種 Modal -->
      <div id="mmModelModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm items-center justify-center hidden z-40">
        <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full mx-4 p-5 space-y-4">
          <div class="flex items-center justify-between">
            <h3 id="mmModelModalTitle" class="font-semibold text-lg">新增機種</h3>
            <button class="btn btn-ghost text-sm" onclick="mmCloseModelModal()">✕</button>
          </div>
          <form id="mmModelForm" class="space-y-3" onsubmit="mmSubmitModelForm(event)">
            <div class="grid md:grid-cols-2 gap-3">
              <div class="field">
                <label class="label-xs">機種代碼 (model_id)</label>
                <input id="mmModelId" class="input" placeholder="如 EDS-518A-SS-SC-80" />
              </div>
              <div class="field">
                <label class="label-xs">機種名稱</label>
                <input id="mmModelName" class="input" placeholder="機種顯示名稱" />
              </div>
            </div>
            <div class="field">
              <label class="label-xs">備註</label>
              <textarea id="mmModelNote" class="input" rows="2"></textarea>
            </div>
            <div class="flex items-center justify-end gap-2 pt-2 border-t">
              <button type="button" class="btn btn-ghost" onclick="mmCloseModelModal()">取消</button>
              <button type="submit" class="btn btn-primary">儲存</button>
            </div>
          </form>
        </div>
      </div>

      <!-- 站點 Master Modal -->
      <div id="stStationModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm items-center justify-center hidden z-40">
        <div class="bg-white rounded-2xl shadow-xl max-w-3xl w-full mx-4 p-5 space-y-4">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold text-lg">站點主檔維護</h3>
            <button class="btn btn-ghost text-sm" onclick="stCloseStationMasterModal()">✕</button>
          </div>
          <div class="grid md:grid-cols-3 gap-3">
            <div class="field">
              <label class="label-xs">站點代碼 (station_code)</label>
              <input id="stCode" class="input" placeholder="如 T1_MP" />
            </div>
            <div class="field">
              <label class="label-xs">站點名稱</label>
              <input id="stName" class="input" placeholder="如 T1 量產" />
            </div>
            <div class="field">
              <label class="label-xs">備註</label>
              <input id="stNote" class="input" />
            </div>
          </div>
          <div class="flex items-center justify-between">
            <div class="text-xs text-gray-500">
              編輯模式：<span id="stModeLabel">新增</span>
            </div>
            <div class="flex gap-2">
              <button class="btn btn-ghost btn-xs" onclick="stResetForm()">清空</button>
              <button class="btn btn-primary btn-xs" onclick="stSubmitForm()">儲存</button>
            </div>
          </div>

          <div class="border-t pt-3">
            <div class="flex items-center justify-between mb-1">
              <div class="text-sm font-semibold">站點列表</div>
              <button class="btn btn-ghost btn-xs" onclick="stLoadStationMasterList()">重新整理</button>
            </div>
            <div class="overflow-auto max-h-64 border rounded-xl">
              <table class="min-w-full text-xs">
                <thead class="bg-gray-50 text-gray-500">
                  <tr>
                    <th class="py-1 px-2 text-left">ID</th>
                    <th class="py-1 px-2 text-left">代碼</th>
                    <th class="py-1 px-2 text-left">名稱</th>
                    <th class="py-1 px-2 text-left">備註</th>
                    <th class="py-1 px-2 text-left">操作</th>
                  </tr>
                </thead>
                <tbody id="stTable"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
</section>


        <!-- ================================ -->
        <!-- 🟦 Fixture Detail Drawer        -->
        <!-- ================================ -->
        <div id="fixtureDetailDrawer"
                  class="fixed top-0 right-0 w-full md:w-2/3 lg:w-1/2 h-full bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-50 overflow-y-auto">

          <div class="flex justify-between items-center p-4 border-b">
            <h2 class="text-lg font-semibold">治具詳情</h2>
            <button onclick="closeFixtureDetail()" class="text-gray-500 hover:text-black">
              ✕
            </button>
          </div>

          <div id="fixtureDetailContent" class="p-4 overflow-y-auto h-[calc(100%-60px)]">
            <!-- JS render content here -->
          </div>

        </div>

        <!-- ================================ -->
        <!-- 🟦 Model Detail Drawer (v3.7) -->
        <!-- ================================ -->
        <div id="modelDetailDrawer"
             class="fixed right-0 top-0 h-full w-[480px] bg-white shadow-xl transform translate-x-full transition-all duration-300 z-50">

          <div class="flex justify-between items-center p-4 border-b">
            <h2 class="text-lg font-semibold">機種詳情</h2>
            <button onclick="closeModelDetail()" class="text-gray-500 hover:text-black">✕</button>
          </div>

          <div id="modelDetailContent" class="p-4 overflow-y-auto h-[calc(100%-60px)] text-sm space-y-6">

            <!-- JS 會塞內容 -->

          </div>

        </div>



      <!-- Toast -->
      <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden">
        <div class="bg-gray-900 text-white px-4 py-2 rounded-xl shadow-lg">訊息</div>
      </div>



</div>

                <!-- 引入 JavaScript -->
            <!-- ================================ -->

            <!-- Excel 匯入（必須最上，以便後續所有匯入功能使用） -->
            <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

            <!-- 🧱 基礎服務 API / 工具            -->
            <!-- ================================ -->

            <!-- API 基本設定，如 api()、API_PREFIX、Token 注入、401 處理 -->
            <script src="/js/api/api-config.js"></script>

            <!-- 共用工具（如果你有在用就保留） -->
            <script src="/js/utils/storage.js"></script>
            <script src="/js/utils/utils.js"></script>
            <script src="/js/utils/calculations.js"></script>
            <script src="/js/utils/ui-render.js"></script>

                        <!-- Shared Modules -->
            <script src="/js/shared/serial-utils.js"></script>
            <script src="/js/shared/export-tools.js"></script>
            <script src="/js/shared/ui-table.js"></script>
            <script src="/js/shared/ui-pagination.js"></script>


            <!-- ================================ -->
            <!-- 🔐 認證 / 使用者相關               -->
            <!-- ================================ -->

            <!-- 認證 API：/auth/login, /auth/me -->
            <script src="/js/api/api-auth.js"></script>
            <!-- 認證與登入 UI 控制（loginModal, doLogin, loadCurrentUser） -->
            <script src="/js/app/app-auth.js"></script>

            <!-- 使用者管理 -->
            <script src="/js/api/api-users.js"></script>
            <script src="/js/app/app-users.js"></script>

            <!-- ================================ -->
            <!-- 📇 基礎資料：客戶 / 負責人 / 站點   -->
            <!-- ================================ -->

            <!-- 客戶 -->
            <script src="/js/api/api-customers.js"></script>
            <script src="/js/app/app-customers.js"></script>

            <!-- 負責人 -->
            <script src="/js/api/api-owners.js"></script>
            <script src="/js/app/app-owners.js"></script>

            <!-- 站點 -->
            <script src="/js/api/api-stations.js"></script>
            <script src="/js/app/app-stations.js"></script>

            <!-- ================================ -->
            <!-- 🧩 機種 / 站點綁定 / 治具需求        -->
            <!-- ================================ -->

            <!-- 機種 -->
            <script src="/js/api/api-machine-models.js"></script>
            <script src="/js/app/app-machine-models.js?v=20241204"></script>

            <!-- ================================ -->
            <!-- 🔧 治具主檔 / 收料 / 退料           -->
            <!-- ================================ -->
            <!-- 查詢 -->
            <script src="/js/app/app-query.js"></script>

            <!-- 治具主檔 -->
            <script src="/js/api/api-fixtures.js"></script>
            <script src="/js/app/app-fixtures.js"></script>

            <!-- 收料 -->
            <script src="/js/api/api-receipts.js"></script>
            <script src="/js/app/app-receipts.js"></script>

            <!-- 退料 -->
            <script src="/js/api/api-returns.js"></script>
            <script src="/js/app/app-returns.js"></script>

            <!-- ================================ -->
            <!-- 📒 使用紀錄 / 更換紀錄              -->
            <!-- ================================ -->

            <script src="/js/api/api-usage.js"></script>
            <script src="/js/app/app-usage.js"></script>

            <script src="/js/api/api-replacement.js"></script>
            <script src="/js/app/app-replacement.js"></script>

            <!-- ================================ -->
            <!-- 🔢 序號工具 / 統計                  -->
            <!-- ================================ -->

            <script src="/js/api/api-serials.js"></script>
            <script src="/js/app/app-serials.js"></script>

            <script src="/js/api/api-stats.js"></script>
            <script src="/js/app/app-stats.js"></script>

            <!-- ================================ -->
            <!-- 🏠 主控制（頁面切換/初始化）         -->
            <!-- ================================ -->

            <script src="/js/app/app-main.js"></script>

  </body>
</html>