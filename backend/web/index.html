<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- favicon 放在 /usr/share/nginx/html/favicon.ico -->
  <link rel="icon" href="/favicon.ico" type="image/x-icon">

  <title>治具管理系統</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- 本地 CSS：對應 /usr/share/nginx/html/css/app-main.css -->
  <link rel="stylesheet" href="/css/app-main.css">
</head>


<body class="bg-gray-50 text-gray-900">
        <!-- 登入介面 -->
      <div id="loginModal" class="modal-backdrop">
        <div class="modal space-y-4">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold text-lg">登入</h3>
            <!-- 使用 app-auth.js 的 closeLogin() -->
            <button class="btn btn-ghost text-xs" onclick="closeLogin()">關閉</button>
          </div>
          <div class="grid gap-3">
            <div class="field">
              <label class="label-xs">帳號</label>
              <input id="loginId" class="input" placeholder="輸入帳號" />
            </div>
            <div class="field">
              <label class="label-xs">密碼</label>
              <input id="loginPwd" type="password" class="input" placeholder="輸入密碼" />
            </div>
            <button class="btn btn-primary" onclick="doLogin()">登入</button>
            <p id="loginMsg" class="text-xs text-gray-500"></p>
          </div>
        </div>
      </div>
        <!-- 客戶選擇視窗 -->
        <dialog id="customerSelectModal" class="modal">
          <div class="modal-box space-y-4">
            <h3 class="font-semibold text-lg">請選擇客戶</h3>

            <select id="customerSelect" class="select select-bordered w-full">
              <option value="" disabled selected>請選擇客戶</option>
            </select>

            <div class="flex justify-end gap-2">
              <button class="btn" onclick="confirmCustomerSelection()">確認</button>
            </div>
          </div>
        </dialog>

      <!-- 頂部導覽 -->
        <header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-gray-200">
        <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="h-8 w-8 rounded-xl bg-gray-900 text-white grid place-items-center font-bold">F</div>
            <div>
              <h1 class="text-lg font-semibold leading-tight">治具管理系統</h1>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <span class="pill border-gray-300" id="clock">--:--</span>
              <!-- 目前客戶（可點擊切換） -->
            <span
              id="currentCustomerDisplay"
              class="pill border-gray-300 cursor-pointer hidden"
              title="點擊切換客戶"
              onclick="openCustomerSwitch()"
            >
              客戶：--
            </span>

            <span id="currentUserDisplay" class="text-xs text-gray-600">未登入</span>

            <!-- 登入按鈕 -->
            <button class="btn btn-ghost" id="btnLogin" onclick="showLoginModal()">登入</button>

            <!-- 登出按鈕（預設隱藏） -->
            <button class="btn btn-ghost hidden" id="btnLogout" onclick="doLogout()">登出</button>
          </div>
        </div>
      </header>


  <!-- 主容器 -->
  <main class="mx-auto max-w-7xl p-4 md:p-6 space-y-6">
    <!-- 功能分頁 -->
    <nav class="grid grid-cols-2 md:grid-cols-7 gap-2">
      <button data-tab="dashboard" class="tab tab-active">儀表板</button>
      <button data-tab="receipts"  class="tab">收料/退料登記</button>
      <button data-tab="query"    class="tab">治具/機種查詢</button>
      <button data-tab="logs"     class="tab">使用/更換記錄</button>
      <button data-tab="stats"    class="tab">治具情況統計</button>
      <button data-tab="admin"    class="tab">後台管理</button>
    </nav>

    <!-- 當前切頁標題欄 -->
    <div id="activeTabBanner" class="card px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-8 w-1.5 rounded-full bg-gray-900"></div>
        <div class="section-title" id="activeTabTitle">儀表板</div>
      </div>
    </div>

    <!-- 儀表板 -->
    <section id="tab-dashboard" class="space-y-6">
      <div class="grid md:grid-cols-3 gap-4">
        <div class="card p-5">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">今日收料</h3>
            <span class="pill border-green-300 text-green-700 bg-green-50">即時</span>
          </div>
          <p class="text-3xl font-bold mt-2" id="todayIn">0</p>
          <div class="mt-3 space-y-2" id="todayInList"></div>
        </div>
        <div class="card p-5">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">今日退料</h3>
            <span class="pill border-blue-300 text-blue-700 bg-blue-50">即時</span>
          </div>
          <p class="text-3xl font-bold mt-2" id="todayOut">0</p>
          <div class="mt-3 space-y-2" id="todayOutList"></div>
        </div>
        <div class="card p-5">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">即將更換治具</h3>
            <button class="btn btn-ghost text-s" onclick="downloadCSV('upcoming.csv', mockUpcomingCSV())">匯出</button>
          </div>
          <div class="mt-3 space-y-2 max-h-40 overflow-auto" id="upcomingList"></div>
        </div>
      </div>

      <div class="card p-5">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold">庫存概覽</h3>
          <div class="flex items-center gap-2">
            <input id="searchDash" class="w-48 border rounded-xl px-3 py-1.5 text-sm" placeholder="搜尋治具/機種..." />
            <button class="btn btn-ghost text-sm" onclick="filterDashboard()">篩選</button>
          </div>
        </div>
        <div class="overflow-auto">
          <table class="min-w-full text-sm">
            <thead class="text-left text-gray-500">
              <tr>
                <th class="py-2 pr-4">治具編號</th>
                <th class="py-2 pr-4">名稱</th>
                <th class="py-2 pr-4">機種</th>
                <th class="py-2 pr-4">儲位</th>
                <th class="py-2 pr-4">狀態</th>
                <th class="py-2 pr-4">使用次數/週期</th>
                <th class="py-2 pr-4">負責人</th>
              </tr>
            </thead>
            <tbody id="dashTable"></tbody>
          </table>
        </div>
      </div>
    </section>

       <!-- 收料 / 退料 -->
    <section id="tab-receipts" class="hidden space-y-4">

      <!-- 子分頁 -->
        <div class="flex gap-2">
          <button class="subtab subtab-active"
                  onclick="showTab('rtab-receipts')"
                  data-rtab="receipts">
            收料登記
          </button>

          <button class="subtab"
                  onclick="showTab('rtab-returns')"
                  data-rtab="returns">
            退料登記
          </button>

          <button class="subtab"
                  onclick="showTab('viewAllTab')"
                  data-rtab="viewall">   <!-- ★ 必須加這個 -->
            總檢視
          </button>
        </div>

      <!-- ============================================================= -->
      <!-- 🔵 收料 TAB -->
      <!-- ============================================================= -->
      <div id="rtab-receipts" class="space-y-4">

        <div class="card p-5 space-y-4">
          <h3 class="font-semibold text-lg">收料登記</h3>

          <!-- 新增 / 匯入按鈕 -->
          <div class="flex gap-2 flex-wrap">
            <button class="btn bg-green-600 text-white hover:bg-green-500" onclick="toggleReturnAdd(true)">
              新增收料記錄
            </button>
            <label class="btn btn-ghost cursor-pointer">
              <input id="receiptXlsx" type="file" accept=".xlsx" class="hidden"
                     onchange="handleReceiptImport(this)" />
              匯入 Excel(.xlsx)
            </label>

            <button class="btn btn-ghost" onclick="downloadReceiptTemplate()">下載範本</button>
          </div>

          <!-- 新增表單 -->
          <div id="receiptAddForm" class="border rounded-2xl p-4 bg-green-50 space-y-3">

            <div class="grid md:grid-cols-5 gap-3">
              <div class="field">
                <label class="text-base font-semibold">客戶</label>
                <input id="receiptAddVendor" class="input" placeholder="例：moxa, BNG">
              </div>

              <div class="field">
                <label class="text-base font-semibold">單號</label>
                <input id="receiptAddOrder" class="input" placeholder="例:25123456">
              </div>

              <div class="field">
                <label class="text-base font-semibold">治具編號</label>
                <input id="receiptAddFixture" class="input" placeholder="例：C-00001">
              </div>

              <div class="field">
                <label class="text-base font-semibold">類型</label>
                <select id="receiptAddType" class="input">
                  <option value="batch">批量(e.g. 1~26)</option>
                  <option value="individual">少量序號(serials)</option>
                  <option value="datecode">Datecode + 數量</option>  <!-- ★ 新增 -->
                </select>
              </div>
            </div>

            <!-- 批量：流水號起訖 -->
            <div id="receiptBatchArea" class="grid md:grid-cols-5 gap-3">
              <div class="field">
                <label class="text-base font-semibold">序號起始</label>
                <input id="receiptAddStart" class="input">
              </div>
              <div class="field">
                <label class="text-base font-semibold">序號結束</label>
                <input id="receiptAddEnd" class="input">
              </div>
            </div>

            <!-- 少量序號 -->
            <div id="receiptIndividualArea" class="hidden grid md:grid-cols-5 gap-3">
                <div class="field md:col-span-5">
                  <label class="text-base font-semibold">序號(逗號分隔)</label>
                  <input id="receiptAddSerials" class="input" placeholder="例如：SN001, SN002, SN003">
                </div>
                </div>

            <!-- 日期碼 -->
            <div id="receiptDatecodeArea" class="hidden grid md:grid-cols-5 gap-3">

              <!-- 日期碼：占 2 格 -->
              <div class="field md:col-span-1">
                <label class="text-base font-semibold">Datecode</label>
                <input type="text" id="receiptAddDatecode" class="input"
                       placeholder="例如：2024W12, 20241201">
              </div>
              <!-- 數量：占 2 格 -->
              <div class="field md:col-span-1">
                <label class="text-base font-semibold">收料數量</label>
                <input type="number" id="receiptAddQuantity" class="input"
                       placeholder="例: 50" min="1">
            </div>
                <!-- 空白：和批量一致（占 1 格） -->
              <div class="md:col-span-1"></div>
          </div>

                <!-- 5. 來源類型選擇 (datecode 模式必填) -->
                <div class="form-control mt-4">
                  <label class="text-base font-semibold">
                    <span class="label-text">來源類型</span>
                  </label>
                  <select id="receiptAddSourceType" class="select select-bordered">
                    <option value="customer_supplied">客供</option>
                    <option value="self_purchased">自購</option>
                  </select>
                </div>

            <div class="field">
              <label class="text-base font-semibold">備註</label>
              <input id="receiptAddNote" class="input">
            </div>

            <div class="flex justify-end gap-2">
              <button class="btn btn-ghost" onclick="toggleReceiptAdd(false)">取消</button>
              <button class="btn btn-primary" onclick="submitReceipt()">提交</button>
            </div>
          </div>

        <div class="border-t border-gray-300 my-4"></div>

            <!-- 查詢 -->
          <div class="grid md:grid-cols-9 gap-5">

            <div class="field">
              <input id="receiptSearchDate" class="input" placeholder="日期">
            </div>

            <div class="field">
              <input id="receiptSearchFixture" class="input" placeholder="治具編號">
            </div>

            <div class="field">
              <input id="receiptSearchVendor" class="input" placeholder="客戶">
            </div>

            <div class="field">
              <input id="receiptSearchOrder" class="input" placeholder="單號">
            </div>

            <div class="field">
              <input id="receiptSearchDatecode" class="input" placeholder="datecode">
            </div>

            <div class="field">
              <input id="receiptSearchSerial" class="input" placeholder="序號">
            </div>

            <div class="field">
              <input id="receiptSearchOperator" class="input" placeholder="操作人員">
            </div>

            <div class="flex items-end">
                <button class="btn bg-gray-400 w-full" onclick="loadReceipts()">查詢</button>
            </div>
          </div>

          <!-- 收料表格 -->
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="text-left text-gray-500">
                <tr>
                  <th class="py-2 pr-4">日期</th>
                  <th class="py-2 pr-4">治具</th>
                  <th class="py-2 pr-4">客戶</th>
                  <th class="py-2 pr-4">單號</th>
                  <th class="py-2 pr-4">來源</th>
                  <th class="py-2 pr-4">Datecode</th>
                  <th class="py-2 pr-4">序號</th>
                  <th class="py-2 pr-4">操作人員</th>
                  <th class="py-2 pr-4">備註</th>
                  <th class="py-2 pr-4">編輯</th> <!-- ★ 新增 -->
                </tr>
                </thead>
              <tbody id="receiptTable"></tbody>
            </table>
            <div id="receiptPagination" class="flex mt-4 justify-center"></div>
          </div>
        </div>

      </div>

      <!-- ============================================================= -->
      <!-- 🟠 退料 TAB -->
      <!-- ============================================================= -->
      <div id="rtab-returns" class="space-y-4">

        <div class="card p-5 space-y-4">
          <h3 class="font-semibold text-lg">退料登記</h3>

          <!-- 新增 / 匯入 -->
          <div class="flex gap-2 flex-wrap">
            <button class="btn bg-blue-600 text-white hover:bg-blue-700" onclick="toggleReturnAdd(true)">
              新增退料記錄</button>

              <label class="btn btn-ghost cursor-pointer">
              <input id="returnXlsx" type="file" accept=".xlsx" class="hidden"
                     onchange="handleReturnImport(this)" />
              匯入 Excel(.xlsx)
            </label>

            <button class="btn btn-ghost" onclick="downloadReturnTemplate()">下載範本</button>
          </div>

          <!-- 新增表單 -->
          <div id="returnAddForm" class="border rounded-2xl p-4 bg-blue-50 space-y-3">

            <div class="grid md:grid-cols-5 gap-4">
              <div class="field">
                <label class="text-base font-semibold">客戶</label>
                <input id="returnAddVendor" class="input" placeholder="例：moxa, BNG">
              </div>

              <div class="field">
                <label class="text-base font-semibold">單號</label>
                <input id="returnAddOrder" class="input" placeholder="例:25123456">
              </div>

              <div class="field">
                <label class="text-base font-semibold">治具編號</label>
                <input id="returnAddFixture" class="input" placeholder="例：C-00001">
              </div>

              <div class="field">
                <label class="text-base font-semibold">類型</label>
                <select id="returnAddType" class="input">
                  <option value="batch">批量(e.g. 1~26)</option>
                  <option value="individual">少量序號(serials)</option>
                  <option value="datecode">Datecode + 數量</option>  <!-- ★ 新增 -->
                </select>
              </div>
            </div>

            <!-- 批量：流水號起訖 -->
            <div id="returnBatchArea" class="grid md:grid-cols-5 gap-3">
              <div class="field">
                <label class="text-base font-semibold">序號起始</label>
                <input id="returnAddStart" class="input">
              </div>
              <div class="field">
                <label class="text-base font-semibold">序號結束</label>
                <input id="returnAddEnd" class="input">
              </div>
            </div>

            <!-- 少量序號 -->
            <div id="returnIndividualArea" class="hidden grid md:grid-cols-5 gap-3">
              <div class="field md:col-span-5">
                <label class="text-base font-semibold">序號(逗號分隔)</label>
                <input id="returnAddSerials" class="input" placeholder="例如：SN001, SN002, SN003">
              </div>
            </div>

            <!-- 日期碼 -->
            <div id="returnDatecodeArea" class="hidden grid md:grid-cols-5 gap-3">

              <!-- 日期碼：占 2 格 -->
              <div class="field md:col-span-1">
                <label class="text-base font-semibold">Datecode</label>
                <input type="text"
                       id="returnAddDatecode"
                       class="input"
                       placeholder="例如：2024W12, 20241201">
              </div>

              <!-- 數量：占 2 格 -->
              <div class="field md:col-span-1">
                <label class="text-base font-semibold">退料數量</label>
                <input type="number"
                       id="returnAddQuantity"
                       class="input"
                       placeholder="例如：30" min="1">
              </div>

              <!-- 空白：和批量一致（占 1 格） -->
              <div class="md:col-span-1"></div>

            </div>
              <!-- 5. 來源類型選擇 (datecode 模式必填) -->
                <div class="form-control mt-4">
                  <label class="text-base font-semibold">
                    <span class="label-text">來源類型</span>
                  </label>
                  <select id="returnAddSourceType" class="select select-bordered">
                    <option value="customer_supplied">客供</option>
                    <option value="self_purchased">自購</option>
                  </select>
                </div>



            <div class="field">
              <label class="text-base font-semibold">備註</label>
              <input id="returnAddNote" class="input">
            </div>

            <div class="flex justify-end gap-2">
              <button class="btn btn-ghost" onclick="toggleReturnAdd(false)">取消</button>
              <button class="btn btn-primary" onclick="submitReturn()">提交</button>
            </div>
          </div>

            <div class="border-t border-gray-300 my-4"></div>

             <!-- 查詢 -->
          <div class="grid md:grid-cols-9 gap-5">
              <div class="field">
              <input id="returnSearchDate" class="input" placeholder="日期">
            </div>

            <div class="field">
              <input id="returnSearchFixture" class="input" placeholder="治具編號">
            </div>

            <div class="field">
              <input id="returnSearchVendor" class="input" placeholder="客戶">
            </div>

            <div class="field">
              <input id="returnSearchOrder" class="input" placeholder="單號">
            </div>

            <div class="field">
              <input id="returnSearchDatecode" class="input" placeholder="datecode">
            </div>

            <div class="field">
              <input id="returnSearchSerial" class="input" placeholder="序號">
            </div>

            <div class="field">
              <input id="returnSearchOperator" class="input" placeholder="操作人員">
            </div>

            <div class="flex items-end">
                <button class="btn bg-gray-400 w-full" onclick="loadReturns()">查詢</button>
            </div>
          </div>

          <!-- 退料表格 -->
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="text-left text-gray-500">
                <tr>
                  <th class="py-2 pr-4">日期</th>
                  <th class="py-2 pr-4">治具</th>
                  <th class="py-2 pr-4">客戶</th>
                  <th class="py-2 pr-4">單號</th>
                  <th class="py-2 pr-4">來源</th>
                  <th class="py-2 pr-4">Datecode</th>
                  <th class="py-2 pr-4">序號</th>
                  <th class="py-2 pr-4">操作人員</th>
                  <th class="py-2 pr-4">備註</th>
                  <th class="py-2 pr-4">編輯</th> <!-- ★ 新增 -->
                </tr>
                </thead>
              <tbody id="returnTable"></tbody>
            </table>
              <div id="returnPagination" class="flex gap-2 mt-3 justify-center"></div>
          </div>
        </div>
      </div>
        <!-- ===================== -->
        <!-- ★ 總檢視 TAB（風格統一版） -->
        <!-- ===================== -->
        <div id="viewAllTab" class="hidden space-y-4">

          <!-- 查詢區 -->
          <div class="card p-5 space-y-4">
            <h3 class="font-semibold text-lg">收 / 退料總檢視</h3>

            <div class="grid md:grid-cols-6 gap-3">
              <div class="field">
                <label class="text-base font-semibold">治具編號</label>
                <input id="vaFixture" class="input" placeholder="治具編號">
              </div>

              <div class="field">
                <label class="text-base font-semibold">Datecode</label>
                <input id="vaDatecode" class="input" placeholder="Datecode">
              </div>

              <div class="field">
                <label class="text-base font-semibold">操作人員</label>
                <input id="vaOperator" class="input" placeholder="員工號">
              </div>

              <div class="field">
                <label class="text-base font-semibold">類型</label>
                <select id="vaType" class="input">
                  <option value="">全部</option>
                  <option value="receipt">收料</option>
                  <option value="return">退料</option>
                </select>
              </div>
             </div>
            <div class="flex gap-3">

              <button class="px-5 py-2 rounded-xl bg-[#0d1321] text-white font-semibold hover:opacity-90"
                      onclick="loadTransactionViewAll()">
                查詢
              </button>

              <button class="px-5 py-2 rounded-xl bg-[#0d1321] text-white font-semibold hover:opacity-90"
                      onclick="exportSummary()">
                匯出
              </button>

              <button class="px-5 py-2 rounded-xl bg-[#0d1321] text-white font-semibold hover:opacity-90"
                      onclick="exportSummaryDetailed()">
                匯出 (detailed)
              </button>

            </div>


            <!-- 表格 -->
            <div class="overflow-auto">
              <table class="min-w-full text-sm">
                <thead class="text-left text-gray-500">
                  <tr>
                    <th class="py-2 pr-4">日期</th>
                    <th class="py-2 pr-4">類型</th>
                    <th class="py-2 pr-4">治具</th>
                    <th class="py-2 pr-4">客戶</th>
                    <th class="py-2 pr-4">來源</th>
                    <th class="py-2 pr-4">Datecode</th>
                    <th class="py-2 pr-4">數量</th>
                    <th class="py-2 pr-4">操作人員</th>
                    <th class="py-2 pr-4">備註</th>
                  </tr>
                </thead>

                <tbody id="viewAllTableBody"></tbody>
              </table>
              <div id="viewAllPagination" class="flex gap-2 mt-3 justify-center"></div>
            </div>
          </div>
        </div>

    </section>

        <!-- 查詢模塊 -->
        <section id="tab-query" class="hidden space-y-4">
          <div class="card p-5 space-y-4">
            <h3 class="font-semibold text-lg">治具／機種查詢</h3>

            <!-- 查詢類型 -->
            <div class="flex gap-4 items-center">
              <label class="font-semibold">查詢類型：</label>
              <select id="queryType" class="input w-60" onchange="switchQueryType()">
                <option value="fixture">治具查詢</option>
                <option value="model">機種查詢</option>
              </select>
            </div>

            <!-- ====================================================== -->
            <!-- 🔵 治具查詢 -->
            <!-- ====================================================== -->
            <div id="fixtureQueryArea" class="space-y-3">

              <div class="flex items-center gap-4 mb-4">
                <div>
                  <span class="query-label">治具搜尋：</span>
                  <input id="fixtureSearch"
                         class="query-input"
                         placeholder="輸入治具編號 / 名稱"
                         oninput="debounceLoadFixtures()">
                </div>

                <div>
                  <span class="query-label">狀態：</span>
                  <select id="fixtureStatus" class="query-input" onchange="loadFixturesQuery()">
                    <option>全部</option>
                    <option>正常</option>
                    <option>維修中</option>
                    <option>報廢</option>
                  </select>
                </div>

                <button onclick="loadFixturesQuery()" class="btn btn-primary">搜尋</button>
              </div>

              <div class="overflow-x-auto border rounded-lg shadow-sm">
                <table class="min-w-full text-sm text-center border-collapse">
                  <thead class="text-gray-700 bg-gray-50 border-b">
                    <tr>
                      <th class="py-2 px-4 w-24">治具編號</th>
                      <th class="py-2 px-4 w-32">名稱</th>
                      <th class="py-2 px-4 w-24">客戶</th>
                      <th class="py-2 px-4 w-32">類型</th>
                      <th class="py-2 px-4 w-44">庫存(自購/客供/總)</th>
                      <th class="py-2 px-4 w-24">狀態</th>
                      <th class="py-2 px-4 w-24">儲位</th>
                      <th class="py-2 px-4 w-32">負責人</th>
                      <th class="py-2 px-4 w-48">備註</th>
                    </tr>
                  </thead>
                  <tbody id="fixtureTable" class="divide-y divide-gray-100 text-gray-800"></tbody>
                </table>

                <div id="fixtureQueryPagination"
                     class="flex gap-2 mt-3 justify-center"></div>
              </div>
            </div>

            <!-- ====================================================== -->
            <!-- 🔵 機種查詢 -->
            <!-- ====================================================== -->
            <div id="modelQueryArea" class="hidden space-y-3">

              <div class="flex gap-3">
                <input id="modelSearch"
                       class="input w-64"
                       placeholder="輸入機種代碼或名稱"
                       oninput="loadModelsQuery()" />

                <button class="btn btn-primary" onclick="loadModelsQuery()">查詢</button>
              </div>

              <div class="overflow-x-auto border rounded-lg shadow-sm">
                <table class="min-w-full text-sm text-center border-collapse">
                  <thead class="text-gray-700 bg-gray-50 border-b">
                    <tr>
                      <th class="py-2 px-4 w-32">機種代碼</th>
                      <th class="py-2 px-4 w-40">名稱</th>
                      <th class="py-2 px-4 w-24">客戶</th>
                      <th class="py-2 px-4 w-64">備註</th>
                      <th class="py-2 px-4 w-24">操作</th>
                    </tr>
                  </thead>
                  <tbody id="modelTable" class="divide-y divide-gray-100 text-gray-800"></tbody>
                </table>

                <div id="modelQueryPagination"
                     class="flex gap-2 mt-3 justify-center"></div>
              </div>

              <!-- ====================================================== -->
              <!-- 三段式 UI：站點綁定 + 治具需求設定 -->
              <!-- ====================================================== -->
              <div id="msNoModelHint"
                   class="text-center text-gray-500 py-5">
              </div>

              <div id="msContent" class="hidden grid grid-cols-2 gap-6 mt-4">

                <!-- ====================================================== -->
                <!-- 左側：站點綁定 -->
                <!-- ====================================================== -->
                <div class="space-y-4">

                  <h4 class="font-semibold text-lg">已綁定站點</h4>

                  <div class="overflow-x-auto border rounded-lg shadow-sm">
                    <table class="min-w-full text-sm">
                      <thead class="bg-gray-50 text-gray-600">
                        <tr>
                          <th class="py-2 px-3">站點代碼</th>
                          <th class="py-2 px-3">名稱</th>
                          <th class="py-2 px-3">治具需求</th>
                          <th class="py-2 px-3">操作</th>
                        </tr>
                      </thead>
                      <tbody id="msBoundTable"></tbody>
                    </table>
                  </div>

                  <h4 class="font-semibold text-lg mt-6">可綁定站點</h4>

                  <div class="overflow-x-auto border rounded-lg shadow-sm">
                    <table class="min-w-full text-sm">
                      <thead class="bg-gray-50 text-gray-600">
                        <tr>
                          <th class="py-2 px-3">站點代碼</th>
                          <th class="py-2 px-3">名稱</th>
                          <th class="py-2 px-3">操作</th>
                        </tr>
                      </thead>
                      <tbody id="msAvailableTable"></tbody>
                    </table>
                  </div>
                </div>

                <!-- ====================================================== -->
                <!-- 右側：治具需求設定 -->
                <!-- ====================================================== -->
                <div class="space-y-4">

                  <h4 class="font-semibold text-lg">
                    治具需求設定：<span id="reqStationLabel" class="text-indigo-600"></span>
                  </h4>

                  <!-- 新增治具需求按鈕 -->
                  <button class="btn btn-primary btn-sm"
                          onclick="openRequirementModal('create')">
                    ➕ 新增治具需求
                  </button>

                  <!-- 已設定治具需求 -->
                  <div class="overflow-x-auto border rounded-lg shadow-sm">
                    <table class="min-w-full text-sm">
                      <thead class="bg-gray-50 text-gray-600">
                        <tr>
                          <th class="py-2 px-3">治具 ID</th>
                          <th class="py-2 px-3">名稱</th>
                          <th class="py-2 px-3">需求數</th>
                          <th class="py-2 px-3">備註</th>
                          <th class="py-2 px-3">操作</th>
                        </tr>
                      </thead>
                      <tbody id="reqTable"></tbody>
                    </table>
                  </div>

                </div>
              </div>
            </div>
          </div>
        </section>

<!-- ============================================================ -->
<!-- 🔵 新增 / 編輯治具需求 Modal（共用） -->
<!-- ============================================================ -->
<div id="requirementModal"
     class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50"
     style="display:none;">
  <div class="bg-white rounded-xl shadow-xl p-6 w-[400px] space-y-4">

    <h3 id="reqModalTitle" class="text-lg font-semibold">新增治具需求</h3>

    <!-- 模式：create / edit -->
    <input type="hidden" id="reqModalMode" />
    <input type="hidden" id="reqModalReqId" />

    <!-- create 才顯示 -->
    <div id="reqModalFixtureBlock">
      <label class="text-sm font-medium">治具編號</label>
      <input id="reqModalFixtureId" class="input w-full" placeholder="例如：FIX-001" />
    </div>

    <div>
      <label class="text-sm font-medium">需求數量</label>
      <input id="reqModalRequiredQty" type="number" class="input w-full" />
    </div>

    <div>
      <label class="text-sm font-medium">備註</label>
      <textarea id="reqModalNote" class="input w-full" rows="2"></textarea>
    </div>

    <div class="flex justify-end gap-3">
      <button class="btn btn-ghost" onclick="closeRequirementModal()">取消</button>
      <button class="btn btn-primary" onclick="submitRequirementModal()">確認</button>
    </div>

  </div>
</div>




    <!-- 治具情況統計(新增分頁) -->
    <section id="tab-stats" class="hidden space-y-4">
      <!-- 統計卡片 -->
      <div class="grid md:grid-cols-4 gap-4">
        <div class="card p-5 stat-card">
          <div class="text-sm opacity-90">總治具數量</div>
          <div class="text-3xl font-bold mt-2" id="statTotalFixtures">0</div>
        </div>
        <div class="card p-5 bg-gradient-to-br from-green-400 to-emerald-600 text-white">
          <div class="text-sm opacity-90">正常使用中</div>
          <div class="text-3xl font-bold mt-2" id="statActiveFixtures">0</div>
        </div>
        <div class="card p-5 bg-gradient-to-br from-amber-400 to-orange-600 text-white">
          <div class="text-sm opacity-90">壽命未達標</div>
          <div class="text-3xl font-bold mt-2" id="statUnderLifespan">0</div>
        </div>
        <div class="card p-5 bg-gradient-to-br from-red-400 to-rose-600 text-white">
          <div class="text-sm opacity-90">即將更換</div>
          <div class="text-3xl font-bold mt-2" id="statNeedReplacement">0</div>
        </div>
      </div>

      <!-- 治具壽命管理作法 -->
      <div class="card p-5 space-y-4">
        <h3 class="font-semibold text-lg">治具壽命管理作法(針對不耐用治具)</h3>

        <div class="grid md:grid-cols-2 gap-4">
          <!-- 1. 建立壽命比對機制 -->
          <div class="border rounded-xl p-4 space-y-3">
            <div class="flex items-center gap-2">
              <div class="h-8 w-8 rounded-lg bg-blue-100 text-blue-700 grid place-items-center font-bold">1</div>
              <h4 class="font-semibold">建立壽命比對機制</h4>
            </div>
            <ul class="text-sm text-gray-600 space-y-2 ml-10">
              <li>• 每個治具設定預期壽命(次數或天數)</li>
              <li>• 系統記錄實際使用次數</li>
              <li>• 未達標自動標示「壽命未達預設值」</li>
            </ul>
          </div>

          <!-- 2. 自動分類與標示 -->
          <div class="border rounded-xl p-4 space-y-3">
            <div class="flex items-center gap-2">
              <div class="h-8 w-8 rounded-lg bg-green-100 text-green-700 grid place-items-center font-bold">2</div>
              <h4 class="font-semibold">自動分類與標示</h4>
            </div>
            <ul class="text-sm text-gray-600 space-y-2 ml-10">
              <li>• 系統自動歸類「不耐用治具」清單</li>
              <li>• 顯示紅色警示</li>
              <li>• 儀表板可統計比例</li>
            </ul>
          </div>

          <!-- 3. 原因分析與回報 -->
          <div class="border rounded-xl p-4 space-y-3">
            <div class="flex items-center gap-2">
              <div class="h-8 w-8 rounded-lg bg-amber-100 text-amber-700 grid place-items-center font-bold">3</div>
              <h4 class="font-semibold">原因分析與回報</h4>
            </div>
            <ul class="text-sm text-gray-600 space-y-2 ml-10">
              <li>• 報廢時填寫損壞原因、使用環境</li>
              <li>• 可上傳照片</li>
              <li>• 供工程部分析設計問題</li>
            </ul>
          </div>

          <!-- 4. 系統提醒與學習回饋 -->
          <div class="border rounded-xl p-4 space-y-3">
            <div class="flex items-center gap-2">
              <div class="h-8 w-8 rounded-lg bg-purple-100 text-purple-700 grid place-items-center font-bold">4</div>
              <h4 class="font-semibold">系統提醒與學習回饋</h4>
            </div>
            <ul class="text-sm text-gray-600 space-y-2 ml-10">
              <li>• 若同型號多次壽命不足</li>
              <li>• 自動提醒檢討</li>
              <li>• 持續優化治具設計</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- 不耐用治具清單 -->
      <div class="card p-5 space-y-4">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">不耐用治具清單(壽命未達預設值)</h3>
          <button class="btn btn-ghost text-sm" onclick="downloadCSV('undurable_fixtures.csv', toCSV(getUndurableFixtures()))">匯出清單</button>
        </div>
        <div class="overflow-auto">
          <table class="min-w-full text-sm">
            <thead class="text-left text-gray-500">
              <tr>
                <th class="py-2 pr-4">治具編號</th>
                <th class="py-2 pr-4">名稱</th>
                <th class="py-2 pr-4">預期壽命</th>
                <th class="py-2 pr-4">實際使用</th>
                <th class="py-2 pr-4">達成率</th>
                <th class="py-2 pr-4">警示等級</th>
                <th class="py-2 pr-4">負責人</th>
                <th class="py-2 pr-4">操作</th>
              </tr>
            </thead>
            <tbody id="undurableTable"></tbody>
          </table>
        </div>
      </div>

      <!-- 報廢原因登記表單 -->
      <div class="card p-5 space-y-4">
        <h3 class="font-semibold">報廢原因登記</h3>
        <div class="grid md:grid-cols-6 gap-3">
          <div class="field"><label class="label-s">治具編號</label><select id="scrapFixture" class="input"></select></div>
          <div class="field"><label class="label-s">報廢日期</label><input id="scrapDate" type="date" class="input" /></div>
          <div class="field"><label class="label-s">損壞原因</label>
            <select id="scrapReason" class="input">
              <option>正常磨損</option>
              <option>材質問題</option>
              <option>設計缺陷</option>
              <option>操作不當</option>
              <option>意外損壞</option>
              <option>其他</option>
            </select>
          </div>
          <div class="field"><label class="label-xs">使用環境</label><input id="scrapEnv" class="input" placeholder="如:高溫/潮濕" /></div>
          <div class="field"><label class="label-xs">照片上傳</label><input id="scrapPhoto" type="file" accept="image/*" class="input text-xs" /></div>
          <div class="flex items-end"><button class="btn btn-primary w-full" onclick="toast('已記錄報廢原因')">提交</button></div>
        </div>
        <div class="field">
          <label class="label-xs">詳細說明</label>
          <textarea id="scrapNote" class="input" rows="2" placeholder="請詳細描述損壞情況..."></textarea>
        </div>
      </div>
    </section>


    <!--  使用 / 更換記錄  -->
    <section id="tab-logs" class="hidden space-y-4">

      <!-- 子分頁 -->
      <div class="flex gap-2">
        <button class="subtab subtab-active" data-logtab="usage">使用記錄</button>
        <button class="subtab" data-logtab="replacement">更換記錄</button>
      </div>

      <!-- ========================================================= -->
      <!-- 🔵 使用記錄 TAB v4.0 -->
      <!-- ========================================================= -->
      <div id="logtab-usage" class="space-y-4">
        <div class="card p-5 space-y-4">

          <h3 class="font-semibold text-lg">使用記錄</h3>

          <!-- 查詢區 -->
          <div class="grid md:grid-cols-6 gap-3">

            <div class="field">
              <label class="label-xs">治具</label>
              <input id="usageSearchFixture" class="input" placeholder="治具 ID" />
            </div>

            <div class="field">
              <label class="label-xs">序號</label>
              <input id="usageSearchSerial" class="input" placeholder="SN..." />
            </div>

            <div class="field">
              <label class="label-xs">站點 ID</label>
              <input id="usageSearchStation" class="input" placeholder="T1_MP" />
            </div>

            <div class="field">
              <label class="label-xs">機種 ID</label>
              <input id="usageSearchModel" class="input" placeholder="EDS-2008" />
            </div>

            <div class="field">
              <label class="label-xs">操作人員</label>
              <input id="usageSearchOperator" class="input" placeholder="員工號" />
            </div>

            <div class="flex items-end">
              <button class="btn btn-primary w-full" onclick="loadUsageLogs()">查詢</button>
            </div>

          </div>

          <!-- 新增 / 匯入 -->
          <div class="flex gap-2 flex-wrap">
            <button class="btn btn-primary" onclick="toggleUsageAdd(true)">新增使用記錄</button>

            <label class="btn btn-ghost cursor-pointer">
              <input id="usageXlsx" type="file" accept=".xlsx" class="hidden"
                     onchange="handleUsageImport(this)" />
              匯入 Excel(.xlsx)
            </label>

            <button class="btn btn-ghost" onclick="downloadUsageTemplate()">下載範本</button>
          </div>

          <!-- 新增表單 -->
          <div id="usageAddForm" class="hidden border rounded-2xl p-4 bg-gray-50 space-y-3">

            <div class="grid md:grid-cols-6 gap-3">

              <div class="field">
                <label class="label-xs">治具 ID *</label>
                <input id="usageAddFixture" class="input" />
              </div>

              <div class="field">
                <label class="label-xs">機種 ID *</label>
                <input id="usageAddModel" class="input" />
              </div>

              <div class="field">
                <label class="label-xs">站點 ID *</label>
                <input id="usageAddStation" class="input" />
              </div>

              <div class="field">
                <label class="label-xs">使用次數 *</label>
                <input id="usageAddCount" type="number" class="input" value="1" />
              </div>

              <div class="field">
                <label class="label-xs">操作人員</label>
                <input id="usageAddOperator" class="input" placeholder="預設登入者" />
              </div>

              <div class="field">
                <label class="label-xs">使用時間</label>
                <input id="usageAddTime" type="datetime-local" class="input" />
              </div>

            </div>

            <!-- Record Level -->
            <div class="grid md:grid-cols-6 gap-3">

              <div class="field">
                <label class="label-xs">記錄層級 *</label>
                <select id="usageAddLevel" class="input" onchange="toggleUsageSerialInputs()">
                  <option value="fixture">治具層級</option>
                  <option value="individual">個別序號</option>
                  <option value="batch">批量序號</option>
                </select>
              </div>

              <div id="usageSerialSingleField" class="field hidden">
                <label class="label-xs">序號(逗號分隔)</label>
                <input id="usageAddSerials" class="input" placeholder="SN001, SN002..." />
              </div>

              <div id="usageSerialBatchField" class="field hidden">
                <label class="label-xs">批量起訖</label>
                <div class="flex gap-2">
                  <input id="usageAddSerialStart" class="input" placeholder="SN001" />
                  <input id="usageAddSerialEnd" class="input" placeholder="SN100" />
                </div>
              </div>

            </div>

            <div class="field">
              <label class="label-xs">備註</label>
              <input id="usageAddNote" class="input" />
            </div>

            <div class="flex justify-end gap-2">
              <button class="btn btn-ghost" onclick="toggleUsageAdd(false)">取消</button>
              <button class="btn btn-primary" onclick="submitUsageLog()">提交</button>
            </div>
          </div>

          <!-- 使用記錄表格 -->
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="text-left text-gray-500">
              <tr>
                <th class="py-2 pr-4">日期</th>
                <th class="py-2 pr-4">治具</th>
                <th class="py-2 pr-4">序號</th>
                <th class="py-2 pr-4">站點</th>
                <th class="py-2 pr-4">機種</th>
                <th class="py-2 pr-4">次數</th>
                <th class="py-2 pr-4">操作人員</th>
                <th class="py-2 pr-4">備註</th>
                <th class="py-2 pr-4">刪除</th>
              </tr>
              </thead>
              <tbody id="usageTable"></tbody>
            </table>
          </div>

        </div>
      </div>

      <!-- ========================================================= -->
      <!-- 🟠 更換記錄 TAB（支援序號 / 治具） -->
      <!-- ========================================================= -->
      <div id="logtab-replacement" class="hidden space-y-4">
        <div class="card p-5 space-y-4">

          <h3 class="font-semibold text-lg">更換記錄</h3>

          <!-- 查詢區 -->
          <div class="grid md:grid-cols-6 gap-3">

            <div class="field">
              <label class="label-xs">治具</label>
              <input id="replaceSearchFixture" class="input" />
            </div>

            <div class="field">
              <label class="label-xs">序號(serial 模式)</label>
              <input id="replaceSearchSerial" class="input" />
            </div>

            <div class="field">
              <label class="label-xs">執行人員</label>
              <input id="replaceSearchExec" class="input" />
            </div>

            <div class="field">
              <label class="label-xs">日期起</label>
              <input id="replaceSearchFrom" type="date" class="input" />
            </div>

            <div class="field">
              <label class="label-xs">日期迄</label>
              <input id="replaceSearchTo" type="date" class="input" />
            </div>

            <div class="flex items-end">
              <button class="btn btn-primary w-full" onclick="loadNewReplacementLogs()">查詢</button>
            </div>

          </div>

          <!-- 新增 / 匯入 -->
          <div class="flex gap-2 flex-wrap">
            <button class="btn btn-primary" onclick="toggleReplaceAdd(true)">新增更換記錄</button>

            <label class="btn btn-ghost cursor-pointer">
              <input id="replaceXlsx" type="file" accept=".xlsx" class="hidden"
                     onchange="handleReplaceImport(this)" />
              匯入 Excel(.xlsx)
            </label>

            <button class="btn btn-ghost" onclick="downloadReplaceTemplate()">下載範本</button>
          </div>

          <!-- 新增表單 -->
          <div id="replaceAddForm" class="hidden border rounded-2xl p-4 bg-gray-50 space-y-3">

            <div class="grid md:grid-cols-5 gap-3">
              <div class="field">
                <label class="label-xs">治具 ID *</label>
                <input id="replaceAddFixture" class="input" />
              </div>

              <div class="field">
                <label class="label-xs">更換日期 *</label>
                <input id="replaceAddDate" type="date" class="input" />
              </div>

              <div class="field">
                <label class="label-xs">層級 *</label>
                <select id="replaceAddLevel" class="input" onchange="toggleReplaceSerialField()">
                  <option value="fixture">治具</option>
                  <option value="serial">序號</option>
                </select>
              </div>

              <div class="field hidden" id="replaceSerialField">
                <label class="label-xs">序號</label>
                <input id="replaceAddSerial" class="input" />
              </div>

              <div class="field">
                <label class="label-xs">原因</label>
                <input id="replaceAddReason" class="input" />
              </div>

              <div class="field">
                <label class="label-xs">執行人員</label>
                <input id="replaceAddExecutor" class="input" />
              </div>

            </div>

            <div class="field">
              <label class="label-xs">備註</label>
              <input id="replaceAddNote" class="input" />
            </div>

            <div class="flex justify-end gap-2">
              <button class="btn btn-ghost" onclick="toggleReplaceAdd(false)">取消</button>
              <button class="btn btn-primary" onclick="submitReplacementLog()">提交</button>
            </div>

          </div>

          <!-- 表格 -->
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="text-left text-gray-500">
              <tr>
                <th class="py-2 pr-4">日期</th>
                <th class="py-2 pr-4">治具</th>
                <th class="py-2 pr-4">序號</th>
                <th class="py-2 pr-4">原因</th>
                <th class="py-2 pr-4">執行人員</th>
                <th class="py-2 pr-4">備註</th>
                <th class="py-2 pr-4">刪除</th>
              </tr>
              </thead>
              <tbody id="replaceTable"></tbody>
            </table>
          </div>

        </div>
      </div>

    </section>

    <!-- =========================================================
         後台管理（Admin Only）
    ========================================================= -->
    <section id="tab-admin" class="hidden">

      <div class="grid grid-cols-12 gap-4">

        <!-- ================= 左側：後台選單 ================= -->
        <aside class="col-span-2 card p-3 space-y-2">

          <button class="admin-menu btn btn-sm btn-outline w-full" data-admin-page="stations">
            站點管理
          </button>

          <button class="admin-menu btn btn-sm btn-outline w-full" data-admin-page="fixtures">
            治具管理
          </button>

          <button class="admin-menu btn btn-sm btn-outline w-full" data-admin-page="models">
            機種管理
          </button>

          <button class="admin-menu btn btn-sm btn-outline w-full" data-admin-page="owners">
            負責人管理
          </button>

          <button class="admin-menu btn btn-sm btn-outline w-full" data-admin-page="systems">
            系統設定
          </button>

        </aside>

        <!-- ================= 右側：內容區 ================= -->
        <div class="col-span-10 space-y-4">

          <!-- ========== 站點管理 ========== -->
          <div id="admin-stations" class="admin-page card p-5 space-y-4 hidden">
              <div class="flex items-center justify-between">
                <h3 class="font-semibold text-lg">站點管理</h3>
                <button class="btn btn-primary btn-sm" onclick="stResetForm(); stOpenStationMasterModal();">新增站點</button>
              </div>
              <div class="border-t pt-3">
                <div class="flex items-center justify-between mb-1">
                  <div class="text-sm font-semibold">站點列表</div>
                  <button class="btn btn-ghost btn-xs" onclick="stLoadStationMasterList()">重新整理</button>
                </div>
                <div class="overflow-auto max-h-64 border rounded-xl">
                  <table class="min-w-full text-xs">
                    <thead class="bg-gray-50 text-gray-500">
                      <tr>
                        <th class="py-1 px-2 text-left">ID</th>
                        <th class="py-1 px-2 text-left">代碼</th>
                        <th class="py-1 px-2 text-left">名稱</th>
                        <th class="py-1 px-2 text-left">備註</th>
                        <th class="py-1 px-2 text-left">操作</th>
                      </tr>
                    </thead>
                    <tbody id="stTable"></tbody>
                  </table>
                </div>
              </div>
          </div>


                <!-- ========== 機種管理 ========== -->
        <div id="admin-models" class="admin-page card p-6 space-y-4 hidden">

          <!-- Header -->
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-semibold text-lg">機種資料維護</h3>
              <p class="text-xs text-gray-500">
                管理機種，並設定站點與治具需求
              </p>
            </div>
            <div class="flex items-center gap-2">
                <button class="btn btn-outline btn-sm" onclick="mmExportModelsXlsx()">匯出 XLSX</button>
                <button class="btn btn-outline btn-sm" onclick="mmDownloadModelsTemplate()">下載樣本</button>
                <label class="btn btn-ghost cursor-pointer">
                              <input
                                id="mmImportModels"
                                type="file"
                                accept=".xlsx"
                                class="hidden"
                                onchange="mmImportModels(this.files[0])"
                              />
                              匯入 Excel
                </label>
                <!-- ✅ 主操作 -->
                <button class="btn btn-primary btn-sm"
                        onclick="mmOpenModelModal('create')">
                 新增機種
                </button>
            </div>
          </div>

          <!-- 機種清單 -->
          <section class="border rounded-2xl p-4 space-y-3 bg-white">

            <div class="flex items-center justify-between">
              <div class="field w-64">
                <input
                  id="mmSearch"
                  class="input"
                  placeholder="搜尋機種代碼 / 名稱"
                  onkeydown="if(event.key==='Enter'){ mmLoadModelList(); }"
                />
              </div>

              <div class="flex items-center gap-3 text-xs text-gray-500">
                共 <span id="mmCount">0</span> 筆
                <button class="btn btn-ghost btn-xs" onclick="mmLoadModelList()">重新整理</button>
              </div>
            </div>

            <div class="overflow-auto border rounded-xl max-h-[70vh]">
              <table class="min-w-full text-sm">
                <thead class="bg-gray-50 text-gray-500">
                  <tr>
                    <th class="px-3 py-2 text-left">機種代碼</th>
                    <th class="px-3 py-2 text-left">機種名稱</th>
                    <th class="px-3 py-2 text-left w-32">操作</th>
                  </tr>
                </thead>
                <tbody id="mmTable"></tbody>
              </table>
            </div>

          </section>
        </div>



          <!-- ========== 治具管理 ========== -->
          <div id="admin-fixtures" class="admin-page card p-5 space-y-3 hidden">
          <!-- ===== Header ===== -->
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-semibold">治具資料維護</h3>
              <p class="text-xs text-gray-500">
                管理治具基本資料、數量、狀態與負責人
              </p>
            </div>
                <div class="flex items-center gap-2">
                   <button class="btn btn-outline btn-sm" onclick="fxExportFixturesXlsx()">
                    匯出 XLSX
                  </button>

                  <button class="btn btn-outline btn-sm" onclick="fxDownloadFixturesTemplate()">
                    下載樣本
                  </button>

                  <label class="btn btn-ghost btn-sm cursor-pointer">
                    <input type="file"
                           accept=".xlsx"
                           class="hidden"
                           onchange="fxImportFixtures(this.files[0])" />
                    匯入 Excel
                  </label>
                <!-- ✅ 主操作 -->
                <button class="btn btn-primary btn-sm"
                        onclick="openFixtureModal('create')">
                 新增治具
                </button>
            </div>
          </div>

          <!-- ===== 查詢 / 篩選 ===== -->
          <section class="border rounded-2xl p-3">
            <div class="grid md:grid-cols-5 gap-3">

              <div class="field">
                <label class="label-xs">關鍵字</label>
                <input id="fxSearch"
                       class="input"
                       placeholder="治具編號 / 名稱"
                       onkeydown="if(event.key==='Enter'){fxPage=1;loadFixtureList();}" />
              </div>

              <div class="field">
                <label class="label-xs">狀態</label>
                <select id="fxStatusFilter"
                        class="input"
                        onchange="fxPage=1;loadFixtureList();">
                  <option value="">全部</option>
                  <option value="正常">正常</option>
                  <option value="返還">返還</option>
                  <option value="報廢">報廢</option>
                </select>
              </div>

              <div class="field">
                <label class="label-xs">負責人 (owner_id)</label>
                <input id="fxOwnerFilter"
                       class="input"
                       placeholder="ID（可留空）"
                       onkeydown="if(event.key==='Enter'){fxPage=1;loadFixtureList();}" />
              </div>

              <div class="field">
                <label class="label-xs">每頁筆數</label>
                <select id="fxPageSize"
                        class="input"
                        onchange="fxPage=1;loadFixtureList();">
                  <option value="8">8</option>
                  <option value="20">20</option>
                  <option value="50">50</option>
                </select>
              </div>

              <div class="field flex items-end">
                <button class="btn btn-ghost w-full"
                        onclick="fxPage=1;loadFixtureList();">
                  重新整理
                </button>
              </div>

            </div>
          </section>

          <!-- ===== 列表 / 分頁 ===== -->
          <section class="border rounded-2xl p-3 space-y-2">

            <div class="flex items-center justify-between">
              <div class="text-sm text-gray-600">
                共 <span id="fxCount">0</span> 筆，
                顯示第 <span id="fxPageNow">1</span> /
                <span id="fxPageMax">1</span> 頁
              </div>

              <div class="pagination flex items-center gap-2">
                <button class="btn btn-ghost text-xs"
                        onclick="goFixturePage('first')">«</button>
                <button class="btn btn-ghost text-xs"
                        onclick="goFixturePage('prev')">上一頁</button>
                <button class="btn btn-ghost text-xs"
                        onclick="goFixturePage('next')">下一頁</button>
                <button class="btn btn-ghost text-xs"
                        onclick="goFixturePage('last')">»</button>
              </div>
            </div>

            <div class="overflow-auto">
              <table class="min-w-full text-xs md:text-sm">
                <thead class="text-left text-gray-500">
                  <tr>
                    <th class="py-2 pr-4">治具編號</th>
                    <th class="py-2 pr-4">治具名稱</th>
                    <th class="py-2 pr-4">類型</th>
                    <th class="py-2 pr-4">自購 / 客供 / 總數</th>
                    <th class="py-2 pr-4">儲位</th>
                    <th class="py-2 pr-4">狀態</th>
                    <th class="py-2 pr-4">更換週期</th>
                    <th class="py-2 pr-4">負責人</th>
                    <th class="py-2 pr-4">備註</th>
                    <th class="py-2 pr-4">操作</th>
                  </tr>
                </thead>
                <tbody id="fxTable"></tbody>
              </table>
            </div>

          </section>

        </div>

          <!-- ========== 負責人管理 ========== -->
          <div id="admin-owners" class="admin-page card p-5 space-y-4 hidden">
             <h3 class="font-semibold">負責人管理</h3>
                  <!-- 查詢 -->
              <div class="grid md:grid-cols-4 gap-3">
                <div class="field md:col-span-2">
                  <label class="label-xs">搜尋</label>
                  <input id="ownerSearch" class="input" placeholder="姓名 / Email" onkeydown="if(event.key==='Enter'){ownerPage=1;loadOwners();}" />
                </div>

                <div class="field">
                  <label class="label-xs">狀態</label>
                  <select id="ownerFilterActive" class="input" onchange="ownerPage=1;loadOwners();">
                    <option value="">全部</option>
                    <option value="1">啟用</option>
                    <option value="0">停用</option>
                  </select>
                </div>

                <div class="field flex items-end">
                  <button class="btn btn-primary w-full" onclick="openOwnerAdd()">新增負責人</button>
                </div>
              </div>

              <!-- 表格 -->
              <div class="overflow-auto">
                <table class="min-w-full text-sm">
                  <thead class="text-left text-gray-500">
                    <tr>
                      <th class="py-2 pr-4">ID</th>
                      <th class="py-2 pr-4">主負責人</th>
                      <th class="py-2 pr-4">副負責人</th>
                      <th class="py-2 pr-4">Email</th>
                      <th class="py-2 pr-4">狀態</th>
                      <th class="py-2 pr-4 text-right">操作</th>
                    </tr>
                  </thead>
                  <tbody id="ownerTable"></tbody>
                </table>
                <div id="ownerPagination" class="flex gap-2 mt-3 justify-center"></div>
              </div>
        </div>

          <!-- ========== 系統設定（SMTP） ========== -->
          <div id="admin-system" class="admin-page card p-5 space-y-4 hidden">
            <h3 class="font-semibold">SMTP / 系統設定</h3>
                <div class="grid md:grid-cols-3 gap-3">
                  <div class="field"><label class="label-xs">Email</label><input id="smtpEmail" class="input" placeholder="通知寄送 Email"/></div>
                  <div class="field"><label class="label-xs">外送郵件伺服器名稱 (SMTP)</label><input id="smtpHost" class="input" placeholder="smtp.example.com"/></div>
                  <div class="field"><label class="label-xs">埠號 (Port)</label><input id="smtpPort" class="input" placeholder="587"/></div>
                  <div class="field"><label class="label-xs">認證狀態</label>
                    <select id="smtpAuthState" class="input">
                      <option>未認證</option><option>已認證</option>
                    </select>
                  </div>
                  <div class="field"><label class="label-xs">認證帳號</label><input id="smtpUser" class="input" /></div>
                  <div class="field"><label class="label-xs">認證密碼</label><input id="smtpPass" type="password" class="input" /></div>
                  <div class="field"><label class="label-xs">寄件者名稱</label><input id="smtpSenderName" class="input" /></div>
                  <div class="field"><label class="label-xs">寄件者信箱</label><input id="smtpSenderMail" type="email" class="input" /></div>
                </div>
                <div class="flex gap-2">
                  <button class="btn btn-primary" onclick="toast('已儲存 SMTP(模擬)')">儲存</button>
                  <button class="btn btn-ghost" onclick="toast('測試寄信(模擬)')">測試寄信</button>
                </div>
          </div>

        </div>
      </div>

      <!-- ================= Modal 區（一定要在這層） ================= -->

      <!-- ================= 治具 新增 / 編輯 Modal ================= -->
        <div id="fixtureModal"
             class="fixed inset-0 bg-black/30 backdrop-blur-sm items-center justify-center hidden z-40">

          <div class="bg-white rounded-2xl shadow-xl max-w-3xl w-full mx-4 p-5 space-y-4">

            <!-- ===== Header ===== -->
            <div class="flex items-center justify-between">
              <div>
                <h3 id="fixtureModalTitle" class="font-semibold text-lg">
                  新增治具
                </h3>
                <p class="text-xs text-gray-500">
                  建立或修改治具的基本資料與使用設定
                </p>
              </div>
              <button class="btn btn-ghost text-sm" onclick="closeFixtureModal()">✕</button>
            </div>

            <!-- ===== Form ===== -->
            <form id="fixtureForm"
                  class="space-y-4"
                  onsubmit="submitFixtureForm(event)">

              <!-- === 基本資料 === -->
              <section class="space-y-2">
                <h4 class="text-sm font-semibold text-gray-700">基本資料</h4>

                <div class="grid md:grid-cols-3 gap-3">
                  <div class="field">
                    <label class="label-xs">治具編號 (fixture_id)</label>
                    <input id="fmFixtureId" class="input" placeholder="L-00017" />
                  </div>
                  <div class="field">
                    <label class="label-xs">治具名稱</label>
                    <input id="fmFixtureName" class="input" placeholder="主板測試治具 A" />
                  </div>
                  <div class="field">
                    <label class="label-xs">治具類型</label>
                    <input id="fmFixtureType" class="input" placeholder="測試治具" />
                  </div>
                </div>

                <div class="grid md:grid-cols-4 gap-3">
                  <div class="field">
                    <label class="label-xs">序號 (serial_number)</label>
                    <input id="fmSerialNumber" class="input" placeholder="SN2025..." />
                  </div>
                  <div class="field">
                    <label class="label-xs">儲存位置</label>
                    <input id="fmStorage" class="input" placeholder="倉庫 A-01" />
                  </div>
                </div>
              </section>

              <!-- === 數量設定 === -->
              <section class="space-y-2">
                <h4 class="text-sm font-semibold text-gray-700">數量設定</h4>

                <div class="grid md:grid-cols-2 gap-3">
                  <div class="field">
                    <label class="label-xs">自購數量</label>
                    <input id="fmSelfQty" type="number" min="0" class="input" />
                  </div>
                  <div class="field">
                    <label class="label-xs">客供數量</label>
                    <input id="fmCustomerQty" type="number" min="0" class="input" />
                  </div>
                </div>
              </section>

              <!-- === 使用 / 狀態設定 === -->
              <section class="space-y-2">
                <h4 class="text-sm font-semibold text-gray-700">使用與狀態</h4>

                <div class="grid md:grid-cols-4 gap-3">
                  <div class="field">
                    <label class="label-xs">更換週期 (數值)</label>
                    <input id="fmCycle"
                           type="number"
                           min="0"
                           step="0.01"
                           class="input" />
                  </div>

                  <div class="field">
                    <label class="label-xs">週期單位</label>
                    <select id="fmCycleUnit" class="input">
                      <option value="uses">使用次數</option>
                      <option value="days">天數</option>
                      <option value="none">無</option>
                    </select>
                  </div>

                  <div class="field">
                    <label class="label-xs">狀態</label>
                    <select id="fmStatus" class="input">
                      <option value="正常">正常</option>
                      <option value="返還">返還</option>
                      <option value="報廢">報廢</option>
                    </select>
                  </div>

                  <div class="field">
                    <label class="label-xs">負責人 ID (owner_id)</label>
                    <input id="fmOwnerId" type="number" min="0" class="input" />
                  </div>
                </div>
              </section>

              <!-- === 備註 === -->
              <section class="space-y-2">
                <h4 class="text-sm font-semibold text-gray-700">備註</h4>
                <div class="field">
                  <textarea id="fmNote" class="input" rows="2"></textarea>
                </div>
              </section>

              <!-- ===== Actions ===== -->
              <div class="flex items-center justify-end gap-2 pt-3 border-t">
                <button type="button"
                        class="btn btn-ghost"
                        onclick="closeFixtureModal()">
                  取消
                </button>
                <button type="submit" class="btn btn-primary">
                  儲存
                </button>
              </div>

            </form>
          </div>
        </div>


      <!-- 機種 Modal -->
      <div id="mmModelModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm items-center justify-center hidden z-40">
        <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full mx-4 p-5 space-y-4">
          <div class="flex items-center justify-between">
            <h3 id="mmModelModalTitle" class="font-semibold text-lg">新增機種</h3>
            <button class="btn btn-ghost text-sm" onclick="mmCloseModelModal()">✕</button>
          </div>
          <form id="mmModelForm" class="space-y-3" onsubmit="mmSubmitModelForm(event)">
            <div class="grid md:grid-cols-2 gap-3">
              <div class="field">
                <label class="label-xs">機種代碼 (model_id)</label>
                <input id="mmModelId" class="input" placeholder="如 EDS-518A-SS-SC-80" />
              </div>
              <div class="field">
                <label class="label-xs">機種名稱</label>
                <input id="mmModelName" class="input" placeholder="機種顯示名稱" />
              </div>
            </div>
            <div class="field">
              <label class="label-xs">備註</label>
              <textarea id="mmModelNote" class="input" rows="2"></textarea>
            </div>
            <div class="flex items-center justify-end gap-2 pt-2 border-t">
              <button type="button" class="btn btn-ghost" onclick="mmCloseModelModal()">取消</button>
              <button type="button" class="btn btn-primary" onclick="submitModelForm()">儲存</button>
            </div>
          </form>
        </div>
      </div>

        <!-- 站點新增 / 編輯 Modal -->
        <div id="stationModal"
             class="fixed inset-0 bg-black/30 backdrop-blur-sm hidden z-50 flex items-center justify-center">

          <div class="bg-white rounded-2xl shadow-xl w-full max-w-xl p-5 space-y-4">
            <div class="flex items-center justify-between">
              <h3 id="stationModalTitle" class="font-semibold text-lg">新增站點</h3>
              <button class="btn btn-ghost btn-sm" onclick="closeStationModal()">✕</button>
            </div>

            <div class="grid md:grid-cols-2 gap-3">
              <div class="field">
                <label class="label-xs">站點代碼</label>
                <input id="stCode" class="input" />
              </div>

              <div class="field">
                <label class="label-xs">站點名稱</label>
                <input id="stName" class="input" />
              </div>

              <div class="field md:col-span-2">
                <label class="label-xs">備註</label>
                <input id="stNote" class="input" />
              </div>
            </div>

            <div class="flex justify-end gap-2 pt-3">
              <button class="btn btn-ghost btn-sm" onclick="closeStationModal()">取消</button>
              <button class="btn btn-primary btn-sm" onclick="stSubmitForm()">儲存</button>
            </div>
          </div>
        </div>

        <!-- ========== 機種編輯 Modal ========== -->
        <div id="modelEditModal"
             class="fixed inset-0 z-50 bg-black/40 hidden">

          <div class="absolute inset-6 bg-white rounded-2xl shadow-xl
                      flex flex-col">

            <!-- Header -->
            <div class="px-6 py-4 border-b flex items-center justify-between">
              <div>
                <h3 class="font-semibold text-lg">
                  編輯機種
                  <span id="meModelId" class="text-sm text-gray-500"></span>
                </h3>
                <p class="text-xs text-gray-500">
                  設定站點綁定與治具需求
                </p>
              </div>
              <button class="btn btn-ghost" onclick="closeModelEditModal()">✕</button>
            </div>

            <!-- Content -->
            <div class="flex-1 grid grid-cols-2 gap-6 p-6 overflow-hidden">

              <!-- 左：站點綁定 -->
              <section class="border rounded-xl p-4 overflow-auto">
                <div class="flex items-center justify-between mb-2">
                  <h4 class="font-semibold">站點綁定</h4>
                  <button class="btn btn-ghost btn-xs" onclick="meReloadStations()">
                    重新整理
                  </button>
                </div>

                <div id="meStationPanel">
                  <!-- JS render：已綁 / 可綁站點 -->
                </div>
              </section>

              <!-- 右：治具需求 -->
              <section class="border rounded-xl p-4 overflow-auto">
                <div class="mb-2">
                  <h4 class="font-semibold">
                    治具需求
                    <span id="meSelectedStationLabel"
                          class="text-xs text-gray-500"></span>
                  </h4>
                </div>

                <div id="meFixturePanel">
                  <div class="text-xs text-gray-400">
                    請先在左側選擇一個站點
                  </div>
                </div>
              </section>

            </div>

            <!-- Footer -->
            <div class="px-6 py-4 border-t text-right">
              <button class="btn btn-outline" onclick="closeModelEditModal()">關閉</button>
            </div>

          </div>
        </div>

    </section>

        <!-- ================================ -->
        <!-- 🟦 Fixture Detail Drawer        -->
        <!-- ================================ -->
        <div id="fixtureDetailDrawer"
                  class="fixed top-0 right-0 w-full md:w-2/3 lg:w-1/2 h-full bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-50 overflow-y-auto">

          <div class="flex justify-between items-center p-4 border-b">
            <h2 class="text-lg font-semibold">治具詳情</h2>
            <button onclick="closeFixtureDetail()" class="text-gray-500 hover:text-black">
              ✕
            </button>
          </div>

          <div id="fixtureDetailContent" class="p-4 overflow-y-auto h-[calc(100%-60px)]">
            <!-- JS render content here -->
          </div>

        </div>

        <!-- ================================ -->
        <!-- 🟦 Model Detail Drawer (v3.7) -->
        <!-- ================================ -->
        <div id="modelDetailDrawer"
             class="fixed right-0 top-0 h-full w-[480px] bg-white shadow-xl transform translate-x-full transition-all duration-300 z-50">

          <div class="flex justify-between items-center p-4 border-b">
            <h2 class="text-lg font-semibold">機種詳情</h2>
            <button onclick="closeModelDetail()" class="text-gray-500 hover:text-black">✕</button>
          </div>

          <div id="modelDetailContent" class="p-4 overflow-y-auto h-[calc(100%-60px)] text-sm space-y-6">

            <!-- JS 會塞內容 -->

          </div>

        </div>


      <!-- Toast -->
      <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden">
        <div class="bg-gray-900 text-white px-4 py-2 rounded-xl shadow-lg">訊息</div>
      </div>


    </div>
  </main>
                <!-- 引入 JavaScript -->
            <!-- ================================ -->

            <!-- Excel 匯入（必須最上，以便後續所有匯入功能使用） -->
            <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

            <!-- 🧱 基礎服務 API / 工具            -->
            <!-- ================================ -->

            <!-- API 基本設定，如 api()、API_PREFIX、Token 注入、401 處理 -->
            <script src="/js/api/api-config.js"></script>

            <!-- 共用工具（如果你有在用就保留） -->
            <script src="/js/utils/storage.js"></script>
            <script src="/js/utils/utils.js"></script>
            <script src="/js/utils/calculations.js"></script>
            <script src="/js/utils/ui-render.js"></script>

                        <!-- Shared Modules -->
            <script src="/js/shared/serial-utils.js"></script>
            <script src="/js/shared/export-tools.js"></script>
            <script src="/js/shared/ui-table.js"></script>
            <script src="/js/shared/ui-pagination.js"></script>


            <!-- ================================ -->
            <!-- 🔐 認證 / 使用者相關               -->
            <!-- ================================ -->

            <!-- 認證 API：/auth/login, /auth/me -->
            <script src="/js/api/api-auth.js"></script>
            <!-- 認證與登入 UI 控制（loginModal, doLogin, loadCurrentUser） -->
            <script src="/js/app/app-auth.js"></script>
            <script src="/js/app/app-admin.js"></script>

            <!-- 使用者管理 -->
            <script src="/js/api/api-users.js"></script>
            <script src="/js/app/app-users.js"></script>

            <!-- ================================ -->
            <!-- 📇 基礎資料：客戶 / 負責人 / 站點   -->
            <!-- ================================ -->

            <!-- 客戶 -->
            <script src="/js/api/api-customers.js"></script>
            <script src="/js/app/app-customers.js"></script>

            <!-- 負責人 -->
            <script src="/js/api/api-owners.js"></script>
            <script src="/js/app/app-owners.js"></script>

            <!-- 站點 -->
            <script src="/js/api/api-stations.js"></script>
            <script src="/js/app/app-stations.js"></script>

            <!-- ================================ -->
            <!-- 🧩 機種 / 站點綁定 / 治具需求        -->
            <!-- ================================ -->

            <!-- 機種 -->
            <script src="/js/api/api-machine-models.js"></script>
            <script src="/js/app/app-machine-models.js?v=20241204"></script>
            <script src="/js/api/api-model-detail.js"></script>
            <script src="/js/app/app-machine-models.js"></script>

            <!-- ================================ -->
            <!-- 🔧 治具主檔 / 收料 / 退料           -->
            <!-- ================================ -->
            <!-- 查詢 -->
            <script src="/js/app/app-query.js"></script>
            <script src="/js/app/app-transactions-viewall.js"></script>

            <!-- 治具主檔 -->
            <script src="/js/api/api-fixtures.js"></script>
            <script src="/js/app/app-fixtures.js"></script>

            <!-- 收料 -->
            <script src="/js/api/api-receipts.js"></script>
            <script src="/js/app/app-receipts.js"></script>

            <!-- 退料 -->
            <script src="/js/api/api-returns.js"></script>
            <script src="/js/app/app-returns.js"></script>

            <!-- ================================ -->
            <!-- 📒 使用紀錄 / 更換紀錄              -->
            <!-- ================================ -->

            <script src="/js/api/api-usage.js"></script>
            <script src="/js/app/app-usage.js"></script>

            <script src="/js/api/api-replacement.js"></script>
            <script src="/js/app/app-replacement.js"></script>

            <!-- ================================ -->
            <!-- 🔢 序號工具 / 統計                  -->
            <!-- ================================ -->

            <script src="/js/api/api-serials.js"></script>
            <script src="/js/app/app-serials.js"></script>

            <script src="/js/api/api-stats.js"></script>
            <script src="/js/app/app-stats.js"></script>

            <!-- ================================ -->
            <!-- 🏠 主控制（頁面切換/初始化）         -->
            <!-- ================================ -->

            <script src="/js/app/app-main.js"></script>
      <script>
    /* ============================================================
       🔵 使用記錄 / 更換記錄 TAB 切換控制 (v4.0)
       ============================================================ */
    document.addEventListener("DOMContentLoaded", () => {

      const usageTab = document.getElementById("logtab-usage");
      const replaceTab = document.getElementById("logtab-replacement");

      const tabButtons = document.querySelectorAll(".subtab");

      function switchLogTab(target) {
        // ---- 1) subtab 樣式切換 ----
        tabButtons.forEach(btn => {
          if (btn.dataset.logtab === target) {
            btn.classList.add("subtab-active");
          } else {
            btn.classList.remove("subtab-active");
          }
        });

        // ---- 2) 區域顯示切換 ----
        usageTab.classList.add("hidden");
        replaceTab.classList.add("hidden");

        if (target === "usage") {
          usageTab.classList.remove("hidden");
        } else if (target === "replacement") {
          replaceTab.classList.remove("hidden");
        }
      }

      // ---- 3) 事件註冊 ----
      tabButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          switchLogTab(btn.dataset.logtab);
        });
      });

      // ---- 4) 預設顯示使用記錄 ----
      switchLogTab("usage");
    });
    </script>
    <script>
            document.addEventListener("click", e => {
          const box = document.getElementById("frFixtureSuggest");
          const input = document.getElementById("frFixtureInput");
          if (!box || !input) return;

          if (!box.contains(e.target) && e.target !== input) {
            box.classList.add("hidden");
          }
        });

    </script>

  </body>
</html>